<!DOCTYPE html>
<html lang="en" layout:decorate="~{include/user}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">

<div layout:fragment="content">
  <div class="row">
    <div class="col col-sm-10 col-md-8 mx-auto">
      <div class="page_title mb-4">
        <h2 class="memomentKkukkkuk fw-normal pt-3 pb-2">반려동물 정보 수정</h2>
        <p>반려동물과 나의 기억저장소 <b class="text-primary">Animal Memory <i class="fa-solid fa-paw"></i></b></p>
      </div>
      <div class="card rounded-3">
        <div class="card-body p-4">
          <form action="/member/modifyPet" method="post" class="mb-0">
            <input type="hidden" name="mid" th:value="${mid}">
            <h4 class="memomentKkukkkuk fw-normal py-3">
              반려동물 정보
              <i class="fa-solid fa-paw text-primary"></i>
            </h4>
            <div id="petInfo">
              <ul id="petList">
                <li class="mb-3" th:each="pet, stat :${petDTOs}" th:unless="${#lists.isEmpty(petDTOs)}">
                  <div class="card bg-light border-0 rounded-3 py-4 px-3">
                    <input type="hidden"  th:name="'petDTO[' + ${stat.index} + '].pid'" th:value="${pet.pid}">
                    <input type="hidden"  th:name="'petDTO[' + ${stat.index} + '].mid'" th:value="${pet.mid}">
                    <div class="mb-2">
                      <div class="d-flex justify-content-start align-items-baseline gap-2">
                        <p>우리 반려동물은</p>
                        <input type="radio" class="btn-check"  th:name="'petDTO[' + ${stat.index} + '].type'" th:id="'dog' + ${stat.index}" value="dog" autocomplete="off" th:checked="${pet.type == 'dog'}" required>
                        <label class="btn btn-outline-main" th:for="'dog' + ${stat.index}">
                          <i class="fa-solid fa-dog"></i> 강아지
                        </label>
                        <input type="radio" class="btn-check"  th:name="'petDTO[' + ${stat.index} + '].type'" th:id="'cat' + ${stat.index}" value="cat" autocomplete="off" th:checked="${pet.type == 'cat'}" required>
                        <label class="btn btn-outline-main" th:for="'cat' + ${stat.index}">
                          <i class="fa-solid fa-cat"></i> 고양이
                        </label>
                        <p>예요!<span class="text-danger"> (필수)</span></p>
                      </div>
                    </div>
                    <div class="mb-2">
                      <label class="form-label" th:for="'petname' + ${stat.index}">이름<span class="text-danger"> (필수)</span></label>
                      <input type="text" class="form-control mb-2" th:name="'petDTO[' + ${stat.index} + '].name'" th:id="'petname' + ${stat.index}"
                             placeholder="반려동물 이름을 입력해주세요"
                             th:value="${pet.name}"
                             required maxlength="20"
                             pattern="^[가-힣A-Za-z0-9 ]{1,20}$">
                    </div>
                    <div class="mb-2">
                      <label class="form-label" th:for="'petage' + ${stat.index}">나이<span class="text-danger"> (필수)</span></label>
                      <input type="text" class="form-control mb-2" th:name="'petDTO[' + ${stat.index} + '].age'"  th:id="'petage' + ${stat.index}"
                             placeholder="숫자만 (0~30)"
                             th:value="${pet.age}"
                             required inputmode="numeric" maxlength="2" >
                    </div>
                    <button type="button" class="btnRemovePet btn btn-gray mx-auto">이 정보 지우기</button>
                  </div>
                </li>
              </ul>
            </div>
              <button type="button" id="btnAddPet" class="btn btn-lg btn-outline-main w-100 mb-3">
                <i class="fa-solid fa-circle-plus me-2"></i> 반려동물 추가하기
              </button>
            <button type="submit" class="btn btn-lg btn-main w-100">저장하기</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="alertModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm modal-360">
      <div class="modal-content">
        <div class="modal-header border-bottom-0">
          <h5 class="modal-title">안내</h5>
          <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
        </div>
        <div class="modal-body py-0">
          <p>반려동물 정보는 10마리까지만 등록 가능합니다</p>
        </div>
        <div class="modal-footer border-top-0">
          <div class="d-flex justify-content-center gap-2 flex-nowrap w-100">
            <button class="btn btn-lg btn-main w-100" data-bs-dismiss="modal" type="button">확인</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script layout:fragment="pagescript" th:inline="javascript">
    /////// 반려동물 정보 추가 삭제하기 ///////
    const alertModal = new bootstrap.Modal(document.getElementById('alertModal'))
    const btnAddPet = document.getElementById("btnAddPet");
    const petInfo = document.getElementById("petInfo");
    const petList = document.getElementById("petList");
    let idx = 0;

    function Li(idx){
        return `<li class="mb-3">
                  <div class="card bg-light border-0 rounded-3 py-4 px-3">
                    <div class="mb-2">
                      <div class="d-flex justify-content-start align-items-baseline gap-2">
                        <p>우리 반려동물은</p>
                        <input type="radio" class="btn-check" name="petDTO[${idx}].type" id="dog${idx}" value="dog" autocomplete="off" required>
                        <label class="btn btn-outline-main" for="dog${idx}">
                          <i class="fa-solid fa-dog"></i> 강아지
                        </label>
                        <input type="radio" class="btn-check" name="petDTO[${idx}].type" id="cat${idx}" value="cat" autocomplete="off" required>
                        <label class="btn btn-outline-main" for="cat${idx}">
                          <i class="fa-solid fa-cat"></i> 고양이
                        </label>
                        <p>예요! <span class="text-danger"> (필수)</span></p>
                      </div>
                    </div>
                    <div class="mb-2">
                      <label class="form-label" for="petname${idx}">이름<span class="text-danger"> (필수)</span></label>
                      <input type="text" class="form-control mb-2" name="petDTO[${idx}].name" id="petname${idx}"
                         placeholder="반려동물 이름을 입력해주세요"
                         required maxlength="20"
                         pattern="^[가-힣A-Za-z0-9 ]{1,20}$">
                    </div>
                    <div class="mb-2">
                      <label class="form-label" for="petage${idx}">나이<span class="text-danger"> (필수)</span></label>
                      <input type="text" class="form-control mb-2" name="petDTO[${idx}].age" id="petage${idx}"
                         placeholder="숫자만 (0~30)"
                         required inputmode="numeric" maxlength="2" >
                    </div>
                    <button type="button" class="btnRemovePet btn btn-gray mx-auto">이 정보 지우기</button>
                  </div>
                </li>`
    }

    function reindexPets() {
        const items = [...petList.querySelectorAll("li")];

        items.forEach((li, idx) => {
            // name 속성 재정렬
            li.querySelectorAll("[name]").forEach(el => {
                el.name = el.name.replace(/petDTO\[\d+\]\./, `petDTO[${idx}].`);
            });

            // id / for 재정렬 (겹치지 않게)
            li.querySelectorAll("[id]").forEach(el => {
                el.id = el.id.replace(/\d+$/, "") + idx;
            });
            li.querySelectorAll("label[for]").forEach(label => {
                label.htmlFor = label.htmlFor.replace(/\d+$/, "") + idx;
            });
        });
    }

    btnAddPet.addEventListener("click", function(e){
        e.preventDefault()
        const liCnt = petList.querySelectorAll("li").length
        console.log(petList)
        console.log(liCnt)
        if (liCnt >= 10){
            alertModal.show()
            return
        }
        petList.insertAdjacentHTML("beforeend", Li(liCnt));
    })

    petList.addEventListener("click", (e) => {
        if (!e.target.classList.contains("btnRemovePet")) return;
        e.preventDefault();
        const li = e.target.closest("li");
        if (li) {
            li.remove();
            reindexPets(); // 삭제 후 즉시 재정렬
        }
    });


</script>