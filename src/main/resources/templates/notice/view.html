<!DOCTYPE html>
<html lang="en" layout:decorate="~{include/user}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">

<div layout:fragment="content">
    <!-- /* view 화면 html 코드 작성 부분 */ -->
    <div class="page_title mb-4">
        <a href="/notice/list" class="d-inline-flex align-items-baseline">
            <small class="text-danger">공지사항 게시판 <i class="fa-solid fa-chevron-right fs-xs"></i></small>
        </a>
        <h3 class="memomentKkukkkuk fw-normal mt-2">게시글 보기</h3>
    </div>
    <div class="board_area">
        <div class="card rounded-3">
            <div class="card-body">
                <table class="table table-borderless">
                    <thead>
                    <tr>
                        <td class="tb_title border-bottom pb-3 px-0">
                            <div class="d-flex gap-2 flex-nowrap align-items-end mb-2"></div>
                            <h4 class="py-2" th:text="${notice.title}">제목</h4>
                            <div class="d-flex gap-2 flex-nowrap text-secondary">
                                <p>작성자</p>
                                <p th:text="${#temporals.format(notice.regDate, 'yyyy-MM-dd')}">2025-10-10</p>
                                <p class="ms-auto"><i class="fa-regular fa-eye me-1"></i><span th:text="${notice.readCount}">1</span></p>
                                <p><i class="fa-regular fa-comment-dots me-1"></i>[[${notice.replyCount}]]</p>
                            </div>
                        </td>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- 첨부파일이 있으면 노출 -->
                    <tr>
                        <td class="px-0 py-3">
                            <ul>
                                <li>
                                    <div class="img_wrap">
                                        <img src="/images/hellokitty.jpg" alt="">
                                    </div>
                                </li>
                            </ul>
                        </td>
                    </tr>
                    <!-- 첨부파일이 있으면 노출 끝 -->
                    <tr>
                        <td class="px-0 py-3">
                            <div class="tb_content" th:text="${notice.content}">내용</div>
                        </td>
                    </tr>
                    <tr>
                        <td class="px-0 pt-3">
                            <p><i class="fa-regular fa-comment-dots me-1"></i>[[${notice.replyCount}]]</p>
                            <div class="reply_list_area">
                                <ul></ul>
                            </div>
                            <div class="reply_write_area pt-3">
                                <div class="mb-2">
                                    <textarea name="replyText" id="replyText" class="form-control" placeholder="댓글 내용을 입력해주세요(최대 1000자)"></textarea>
                                </div>
                                <div class="d-flex">
                                    <button class="btnReplyRegister ms-auto btn btn-main">댓글 쓰기</button>
                                </div>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- /* //view 화면 html 코드 작성 끝 */ -->
</div>

<script layout:fragment="pagescript" th:inline="javascript">
    /////// 대댓글 textarea toggle ///////
    const btnReReplyWriteViews = document.querySelectorAll(".btnReReplyWriteView")
    function reReplyStr() {
        return `<div class="reReplyWriteArea">
                <div class="d-flex justify-content-start align-items-start gap-2 py-2">
                  <div class="flex-grow-1">
                    <div class="mb-2">
                      <textarea name="reReplyText" id="reReplyText" class="form-control" placeholder="대댓글 내용을 입력해주세요(최대 1000자)"></textarea>
                    </div>
                    <div class="d-flex">
                      <button class="btnReReplyRegister ms-auto btn btn-main">대댓글 쓰기</button>
                    </div>
                  </div>
                  <div class="flex-shrink-1">
                    <button class="btnReReplyWriteClose btn btn-xs btn-outline-danger">
                      <i class="fa-solid fa-xmark"></i>
                    </button>
                  </div>
                </div>
              </div>`
    }

    btnReReplyWriteViews.forEach(btn => {
        btn.addEventListener("click", function(e){
            e.preventDefault()
            const li = e.target.closest("li.reply_list")
            console.log(li)
            if (li.querySelector(".reply_depth2") == null) {
                li.insertAdjacentHTML("beforeend", `<div class="reply_depth2 ps-4"></div>`)
            }
            const depth2 = li.querySelector(".reply_depth2")
            if (depth2.querySelector(".reReplyWriteArea") != null) {
                return
            }
            depth2.insertAdjacentHTML("beforeend", reReplyStr())
            const btnReReplyWriteClose = depth2.querySelector(".btnReReplyWriteClose")
            btnReReplyWriteClose.addEventListener("click", () => {
                btnReReplyWriteClose.closest(".reReplyWriteArea").remove()
            })
        })
    })

    // ===========================
    // 공지 댓글 기능 추가 (기존 코드 전혀 삭제 안 함)
    // ===========================
    const bno = [[${notice.bno}]];
    const replyList = document.querySelector(".reply_list_area ul");
    const replyText = document.querySelector("#replyText");
    const replyBtn = document.querySelector(".btnReplyRegister");

    // 댓글 목록 불러오기
    async function loadReplies() {
        try {
            const res = await fetch(`/noticereplies/list/${bno}`);
            const data = await res.json();
            if (!data.dtoList || data.dtoList.length === 0) {
                replyList.innerHTML = `<li class="p-2 text-muted">등록된 댓글이 없습니다.</li>`;
                return;
            }

            replyList.innerHTML = data.dtoList.map(r => `
        <li class="reply_list border-bottom" data-rno="${r.rno}">
          <div class="d-flex justify-content-between align-items-start py-2">
            <div>
              <b>${r.nickname || '익명'}</b><br>
              <small class="text-muted" style="margin-left:8px;">${r.regDate || ''}</small><br>
              ${r.deleted ? '<span class="text-secondary">삭제된 댓글입니다.</span>' : r.content}
            </div>
            ${(!r.deleted && (r.owner || r.admin)) ? `
            <div>
              <button class="btn btn-sm btn-outline-secondary btnEdit" data-rno="${r.rno}">수정</button>
              <button class="btn btn-sm btn-outline-danger btnDelete" data-rno="${r.rno}">삭제</button>
            </div>` : ''}
          </div>
        </li>
      `).join("");
        } catch (err) {
            console.error("댓글 로딩 오류:", err);
        }
    }

    // 댓글 등록
    replyBtn.addEventListener("click", async () => {
        const content = replyText.value.trim();
        if (!content) return alert("댓글 내용을 입력해주세요.");
        try {
            const res = await fetch("/noticereplies/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ bno, content })
            });
            if (res.ok) {
                replyText.value = "";
                loadReplies();
            } else {
                alert("댓글 등록 실패");
            }
        } catch (err) {
            console.error(err);
        }
    });

    // 수정 / 삭제
    replyList.addEventListener("click", async (e) => {
        const rno = e.target.dataset.rno;
        if (!rno) return;

        // 삭제
        if (e.target.classList.contains("btnDelete")) {
            if (!confirm("댓글을 삭제하시겠습니까?")) return;
            await fetch(`/noticereplies/delete/${rno}`, { method: "POST" });
            loadReplies();
        }

        // 수정
        if (e.target.classList.contains("btnEdit")) {
            const li = e.target.closest("li");
            const oldText = li.querySelector(".replyContent")?.innerText || "";
            const newText = prompt("수정할 내용을 입력하세요:", oldText);
            if (newText === null) return;
            await fetch(`/noticereplies/${rno}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ rno, content: newText })
            });
            loadReplies();
        }
    });

    // 페이지 진입 시 목록 표시
    loadReplies();
    // ===========================
    // ===========================

</script>
</html>
