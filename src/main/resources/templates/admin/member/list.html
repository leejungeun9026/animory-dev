<!DOCTYPE html>
<html lang="en" layout:decorate="~{include/admin}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<div layout:fragment="content">
  <div class="page_title d-flex align-items-center mb-3">
    <h2>회원 관리</h2>
    <a class="ms-auto btn btn-lg btn-primary" href="/admin/notice/register">글쓰기</a>
  </div>
  <div class="row g-4">
    <div class="col-12">
      <section class="search_area">
        <div class="card">
          <div class="card-body">
            <form action="">
              <div class="d-flex gap-2">
                <select class="form-select w-auto flex-shrink-1" id="" name="">
                  <option value="tc">제목+내용</option>
                  <option value="t">제목</option>
                  <option value="c">내용</option>
                  <option value="w">작성자</option>
                </select>
                <input class="form-control" name="keyword" placeholder="검색어를 입력하세요" type="text">
                <button class="btn btn-secondary text-nowrap" type="submit"><i
                    class="fa-solid fa-magnifying-glass me-1"></i>검색
                </button>
                <button class="btn btn-gray text-nowrap" type="button">초기화</button>
              </div>
            </form>
          </div>
        </div>
      </section>
    </div>
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-end mb-2">
            <small>총 12개 (1/2페이지)</small>
          </div>
          <table class="table border-top align-middle">
            <colgroup>
              <col style="">
              <col style="">
            </colgroup>
            <thead>
            <tr class="center">
              <th>mid</th>
              <th>아이디</th>
              <th>닉네임</th>
              <th>펫 정보</th>
              <th>시터 인증</th>
              <th>가입일</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${#lists.isEmpty(memberList)}">
              <td colspan="5" class="text-center">게시글이 없습니다.</td>
            </tr>
            <tr th:each="member:${memberList}" th:unless="${#lists.isEmpty(memberList)}" class="text-center">
              <td>[[${member.mid}]]</td>
              <td><a th:href="@{/admin/member/view(mid=${member.mid})}"><b class="text-info text-link">[[${member.username}]]</b></a></td>
              <td>
                <p>[[${member.nickname}]] / [[${member.tel}]]</p>
                <p>[[${member.email}]]</p>
              </td>
              <td>
                <p th:if="${member.petCount == 0}" class="">없음</p>
                <p th:unless="${member.petCount == 0}">
                  <a href="">
                    <span class="text-info text-link">있음</span>
                    <span class="badge badge-info">[[${member.petCount}]]</span>
                  </a>
                </p>
              </td>
              <td>
                <a th:href="|javascript:viewModal(${member.mid}, '${member.username}');|"
                   class="btnSitterModal text-info text-link">
                  <p class="sitterStatus"
                     th:id="|sitter-${member.mid}|"
                     th:text="${member.sitter == true ? 'Y' : 'N'}">Y</p>
                </a>
              </td>
              <td th:text="${#temporals.format(member.regDate, 'yyyy-MM-dd HH:mm')}"></td>
            </tr>
            </tbody>
          </table>
          <div class="paging_area mt-3">
            <nav aria-label="Page navigation">
              <ul class="pagination pagination-sm justify-content-center mb-0">
                <li class="page-item disabled">
                  <a class="page-link"><i class="fa-solid fa-angles-left"></i></a>
                </li>
                <li class="page-item">
                  <a class="page-link"><i class="fa-solid fa-chevron-left"></i></a>
                </li>
                <li class="page-item active">
                  <a class="page-link">1</a>
                </li>
                <li class="page-item">
                  <a class="page-link">2</a>
                </li>
                <li class="page-item">
                  <a class="page-link"><i class="fa-solid fa-chevron-right"></i></a>
                </li>
                <li class="page-item">
                  <a class="page-link"><i class="fa-solid fa-angles-right"></i></a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="modal" class="modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">시터 인증</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-gray" data-bs-dismiss="modal">취소</button>
          <button type="button" class="btnModalSubmit btn btn-primary">저장</button>
        </div>
      </div>
    </div>
  </div>

</div>

<script layout:fragment="pagescript" th:inline="javascript">
  const modal = new bootstrap.Modal(document.getElementById('modal'))
  const modalTitle = document.querySelector(".modal-title")
  const modalBody = document.querySelector(".modal-body")
  const btnModalSubmit = document.querySelector(".btnModalSubmit")

  async function loadSitter(mid){
      const {data} = await axios.get('/admin/member/sitter/'+mid);
      return data
  }
  async function modifySitter(mid, sitter){
      const memberObj = { mid, sitter } // DTO 구조와 맞춤
      console.log("modifySitter:", memberObj)
      const {data} = await axios.put(`/admin/member/sitter/${mid}`,  memberObj, {
          headers: { 'Content-Type': 'application/json' }
      });
      return data
  }

  async function viewModal(mid, username) {
      console.log(mid)
      console.log(username)
      let getSitter = await loadSitter(mid)
      modalTitle.innerHTML = "시터 인증"
      modalBody.innerHTML = `<div class="d-flex gap-2 align-items-center">
                                <p>${username}님 시터인증을</p>
                                <select name="sitter" class="selectSitter form-select w-auto" aria-label="시터 인증">
                                    <option value="">선택</option>
                                    <option value="false" ${getSitter === false ? 'selected' : ''}>N 미인증</option>
                                    <option value="true" ${getSitter === true ? 'selected' : ''}>Y 인증</option>
                                </select>
                                <p> 로 변경할까요?</p>
                            </div>`
      modal.show()

      btnModalSubmit.addEventListener("click", async function () {
          const sitter = document.querySelector(".selectSitter").value
          console.log("btnModalSubmit: " + sitter)
          await modifySitter(mid, sitter)
          alert("수정완료")
          modal.hide()

          const sitterText = document.querySelector(`#sitter-${mid}`)
          if (sitterText) {
              sitterText.textContent = sitter === "true" ? "Y" : "N"
          }
      })
  }


</script>