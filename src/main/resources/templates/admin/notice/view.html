<!DOCTYPE html>
<html lang="en" layout:decorate="~{include/admin}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<div layout:fragment="content">
  <div class="page_title d-flex align-items-center mb-3">
    <h2>공지사항 보기</h2>
  </div>
  <div class="board_area">
    <div class="card rounded-3">
      <div class="card-body">
        <table class="table table-borderless">
          <thead>
          <tr>
            <td class="border-bottom px-0 pb-3">
              <div class="d-flex gap-2 flex-nowrap">
                <a class="btn btn-lg btn-secondary" href="/admin/notice/list"><i class="fa-solid fa-chevron-left"></i> 목록으로</a>
                <div class="d-flex gap-2 flex-nowrap ms-auto">
                  <a class="btn btn-lg btn-danger" th:href="@{/admin/notice/remove(bno=${notice.bno})}">삭제</a>
                  <a class="btn btn-lg btn-primary" th:href="@{/admin/notice/modify(bno=${notice.bno})}">수정</a>
                </div>
              </div>
            </td>
          </tr>
          <tr>
            <td class="tb_title border-bottom py-3 px-0">
              <h4 class="py-2" th:text="${notice.title}">제목</h4>
              <div class="d-flex gap-2 flex-nowrap text-secondary">
                <p>작성자</p>
                <p th:text="${#temporals.format(notice.regDate, 'yyyy-MM-dd')}">2025-10-10</p>
                <p class="ms-auto"><i class="fa-regular fa-eye me-1"></i><span th:text="${notice.readCount}">1</span></p>
                  <p>
                      <i class="fa-regular fa-comment-dots me-1"></i>
                      <span th:text="${notice.replyCount}">0</span>
                  </p>

              </div>
            </td>
          </tr>
          </thead>
          <tbody>
          <!-- 첨부파일이 있으면 노출 -->
          <tr>
            <td class="px-0 py-3">
              <ul>
                <li>
                  <div class="img_wrap">
                    <img alt="" src="/images/hellokitty.jpg">
                  </div>
                </li>
              </ul>
            </td>
          </tr>
          <!-- 첨부파일이 있으면 노출 끝 -->
          <tr>
            <td class="px-0 py-3">
              <div class="tb_content" th:text="${notice.content}">내용</div>
            </td>
          </tr>
          <tr>
            <td class="px-0 pt-3">
                <p>
                    <i class="fa-regular fa-comment-dots me-1"></i>
                    <span th:text="${notice.replyCount}">0</span>
                </p>

                <div class="reply_list_area">
                <ul>
                  <li class="reply_list border-bottom">
                    <div class="d-flex justify-content-start align-items-start gap-2 py-2">
                      <div class="flex-grow-1">
                        <b>댓작성자</b>
                        <div class="replyContent">어쩌고저쩌고</div>
                      </div>
                      <div class="flex-shrink-1">
                        <div class="btn-group">
                          <button aria-expanded="false" class="btn btn-xs rounded-2 btn-outline-gray" data-bs-toggle="dropdown"
                                  type="button">
                            <i class="fa-solid fa-ellipsis"></i>
                          </button>
                          <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="">수정</a></li>
                            <li><a class="dropdown-item" href="">삭제</a></li>
                            <li><a class="btnReReplyWriteView dropdown-item">대댓글 달기</a></li>
                          </ul>
                        </div>
                      </div>
                    </div>
                    <div class="reply_depth2 ps-4">
                      <ul>
                        <li class="rerpley_list border-top">
                          <div class="d-flex justify-content-start align-items-start gap-2 py-2">
                            <div class="flex-grow-1">
                              <b>대댓작성자</b>
                              <div class="replyContent">어쩌고저쩌고</div>
                            </div>
                            <div class="flex-shrink-1">
                              <div class="btn-group">
                                <button aria-expanded="false" class="btn btn-xs rounded-2 btn-outline-gray"
                                        data-bs-toggle="dropdown" type="button">
                                  <i class="fa-solid fa-ellipsis"></i>
                                </button>
                                <ul class="dropdown-menu">
                                  <li><a class="dropdown-item" href="">수정</a></li>
                                  <li><a class="dropdown-item" href="">삭제</a></li>
                                </ul>
                              </div>
                            </div>
                          </div>
                        </li>
                        <li class="border-top">
                          <div class="d-flex justify-content-start align-items-start gap-2 py-2">
                            <div class="flex-grow-1">
                              <b>댓작성자</b>
                              <div class="replyContent">어쩌고저쩌고</div>
                            </div>
                            <div class="flex-shrink-1">
                              <div class="btn-group">
                                <button aria-expanded="false" class="btn btn-xs rounded-2 btn-outline-gray"
                                        data-bs-toggle="dropdown" type="button">
                                  <i class="fa-solid fa-ellipsis"></i>
                                </button>
                                <ul class="dropdown-menu">
                                  <li><a class="dropdown-item" href="">수정</a></li>
                                  <li><a class="dropdown-item" href="">삭제</a></li>
                                </ul>
                              </div>
                            </div>
                          </div>
                        </li>
                      </ul>
                    </div>
                  </li>
                  <li class="reply_list border-bottom">
                    <div class="d-flex justify-content-start align-items-start gap-2 py-2">
                      <div class="flex-grow-1">
                        <b>댓작성자</b>
                        <div class="replyContent">어쩌고저쩌고</div>
                      </div>
                      <div class="flex-shrink-1">
                        <div class="btn-group">
                          <button aria-expanded="false" class="btn btn-xs rounded-2 btn-outline-gray" data-bs-toggle="dropdown"
                                  type="button">
                            <i class="fa-solid fa-ellipsis"></i>
                          </button>
                          <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="">수정</a></li>
                            <li><a class="dropdown-item" href="">삭제</a></li>
                            <li><a class="btnReReplyWriteView dropdown-item">대댓글 달기</a></li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </li>
                  <li class="reply_list border-bottom">
                    <div class="d-flex justify-content-start align-items-start gap-2 py-2">
                      <div class="flex-grow-1">
                        <b>댓작성자</b>
                        <div class="replyContent">어쩌고저쩌고</div>
                      </div>
                      <div class="flex-shrink-1">
                        <div class="btn-group">
                          <button aria-expanded="false" class="btn btn-xs rounded-2 btn-outline-gray" data-bs-toggle="dropdown"
                                  type="button">
                            <i class="fa-solid fa-ellipsis"></i>
                          </button>
                          <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="">수정</a></li>
                            <li><a class="dropdown-item" href="">삭제</a></li>
                            <li><a class="btnReReplyWriteView dropdown-item">대댓글 달기</a></li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
              <div class="reply_write_area pt-3">
                <div class="mb-2">
                  <textarea class="form-control" id="replyText" name="replyText"
                            placeholder="댓글 내용을 입력해주세요(최대 1000자)"></textarea>
                </div>
                <div class="d-flex">
                  <button class="btnReplyRegister ms-auto btn btn-gray">댓글 쓰기</button>
                </div>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script layout:fragment="pagescript" th:inline="javascript">
    // ===== 기본 값 =====
    const bno = [[${notice.bno}]];
    const listEl   = document.querySelector(".reply_list_area ul");
    const btnWrite = document.querySelector(".btnReplyRegister");
    const taWrite  = document.querySelector("#replyText");

    // (선택) CSRF
    const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

    // 공통 fetch
    async function call(url, method = "GET", data) {
        const headers = {"Content-Type":"application/json"};
        if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;
        const res = await fetch(url, { method, headers, body: data ? JSON.stringify(data) : null });
        if (res.status === 401) { alert("로그인이 필요합니다."); throw new Error("401"); }
        if (!res.ok) { throw new Error("HTTP " + res.status); }
        const ct = res.headers.get("content-type") || "";
        return ct.includes("application/json") ? res.json() : res.text();
    }

    // 이스케이프
    function escapeHtml(s){ return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    // 한 항목 템플릿
    function itemTpl(d){
        return `
      <li class="reply_list border-bottom" data-rno="${d.rno}">
        <div class="d-flex justify-content-start align-items-start gap-2 py-2">
          <div class="flex-grow-1">
            ${d.deleted ? "" : `<b>${d.nickname ?? "작성자"}</b>`}
            <div class="replyContent">${escapeHtml(d.content)}</div>
          </div>
          <div class="flex-shrink-1">
            ${d.deleted ? "" : `
            <div class="btn-group">
              <button type="button" class="btn btn-xs rounded-2 btn-outline-gray" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fa-solid fa-ellipsis"></i>
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item btnEdit" href="">수정</a></li>
                <li><a class="dropdown-item btnDel" href="">삭제</a></li>
              </ul>
            </div>`}
          </div>
        </div>
      </li>`;
    }

    // 전체 렌더
    function render(list){
        if (!list || list.length === 0) {
            listEl.innerHTML = `<li class="border-bottom py-3 text-secondary">등록된 댓글이 없습니다.</li>`;
            return;
        }
        listEl.innerHTML = list.map(itemTpl).join("");
    }

    // 페이지 상태
    if (typeof window.page === 'undefined') window.page = 1;
    const size = 5;
    let loading = false;
    let last = false;

    // 목록 로드 (첫 페이지 or 다음 페이지)
    async function load(next = false){
        if (loading || (next && last)) return;
        loading = true;
        try{
            if (next) window.page++; else { window.page = 1; last = false; }

            const data = await call(`/noticereplies/list/${bno}?page=${window.page}&size=${size}`);
            console.log('replies:', data);

            updateReplyCount(typeof data.total === 'number' ? data.total : 0);
            const list = Array.isArray(data.dtoList) ? data.dtoList : [];

            if (next){
                if (!list.length){ last = true; return; }
                listEl.insertAdjacentHTML("beforeend", list.map(itemTpl).join(""));
            }else{
                render(list);
                // 첫 페이지가 size보다 작으면 다음 없음
                if (!list.length || list.length < size) last = true;
            }
        }catch(e){
            console.error(e);
            if (!next) render([]);
        }finally{
            loading = false;
        }
    }

    // 등록
    btnWrite?.addEventListener("click", async () => {
        const content = (taWrite?.value || "").trim();
        if (!content) return alert("댓글 내용을 입력해주세요.");
        try {
            await call(`/noticereplies/`, "POST", { bno, content, deleted:false });
            taWrite.value = "";
            await load(false); // 첫 페이지 새로 고침
        } catch(e) {
            console.error(e); alert("댓글 등록 중 오류가 발생했습니다.");
        }
    });

    // 수정/삭제 (이벤트 위임)
    listEl?.addEventListener("click", async (e) => {
        // 수정
        const edit = e.target.closest(".btnEdit");
        if (edit){
            e.preventDefault();
            const li = edit.closest("li.reply_list");
            const rno = li.dataset.rno;
            const oldContent = li.querySelector(".replyContent").textContent.trim();
            const content = prompt("새 댓글 내용:", oldContent);
            if (!content || content === oldContent) return;
            await call(`/noticereplies/${rno}`, "PUT", { content });
            return load(false);
        }

        // 삭제
        const del = e.target.closest(".btnDel");
        if (del){
            e.preventDefault();
            const li  = del.closest("li.reply_list");
            const rno = li?.getAttribute("data-rno");
            if (!rno) return;
            if (!confirm("이 댓글을 삭제하시겠어요?")) return;
            try {
                await call(`/noticereplies/delete/${rno}`, "POST");
                await load(false);
            } catch(e) {
                console.error(e); alert("삭제 중 오류가 발생했습니다.");
            }
        }
    });

    // 첫 로딩
    document.addEventListener("DOMContentLoaded", () => load(false));

    // 스크롤 끝 근처에서 다음 페이지 자동 로드
    // window.addEventListener('scroll', () => {
    //     if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 150) {
    //         load(true);
    //     }
    // });
</script>
