<!DOCTYPE html>
<html lang="en" layout:decorate="~{include/admin}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<div layout:fragment="content">
  <div class="page_title d-flex align-items-center mb-3">
    <h2>공지사항 보기</h2>
  </div>
  <div class="board_area">
    <div class="card rounded-3">
      <div class="card-body">
        <table class="table table-borderless">
          <thead>
          <tr>
            <td class="border-bottom px-0 pb-3">
              <div class="d-flex gap-2 flex-nowrap">
                <a class="btn btn-lg btn-secondary" href="/admin/notice/list"><i class="fa-solid fa-chevron-left"></i> 목록으로</a>
                <div class="d-flex gap-2 flex-nowrap ms-auto">
                  <a class="btn btn-lg btn-danger" th:href="@{/admin/notice/remove(bno=${notice.bno})}">삭제</a>
                  <a class="btn btn-lg btn-primary" th:href="@{/admin/notice/modify(bno=${notice.bno})}">수정</a>
                </div>
              </div>
            </td>
          </tr>
          <tr>
            <td class="tb_title border-bottom py-3 px-0">
              <h4 class="py-2" th:text="${notice.title}">제목</h4>
              <div class="d-flex gap-2 flex-nowrap text-secondary">
                <p>작성자</p>
                <p th:text="${#temporals.format(notice.regDate, 'yyyy-MM-dd')}">2025-10-10</p>
                <p class="ms-auto"><i class="fa-regular fa-eye me-1"></i><span th:text="${notice.readCount}">1</span></p>
                  <p>
                      <i class="fa-regular fa-comment-dots me-1"></i>
                      <span data-reply-count th:text="${notice.replyCount}">0</span>
                  </p>

              </div>
            </td>
          </tr>
          </thead>
          <tbody>
          <!-- 첨부파일이 있으면 노출 -->
          <tr th:if="${notice.noticeFileDTOs != null and notice.noticeFileDTOs.size() > 0}">
              <td class="px-0 py-3">
                  <ul>
                      <li th:each="file : ${notice.noticeFileDTOs}">
                          <a th:href="@{|/uploads/notice/${file.uuid}_${file.fileName}|}"
                             th:download="${file.fileName}"
                             th:text="${file.fileName}"
                             class="text-decoration-underline text-primary"></a>
                      </li>
                  </ul>
              </td>
          </tr>


          <!-- 첨부파일이 있으면 노출 끝 -->
          <tr>
            <td class="px-0 py-3">
              <div class="tb_content" th:text="${notice.content}">내용</div>
            </td>
          </tr>
          <tr>
            <td class="px-0 pt-3">
                <p>
                    <i class="fa-regular fa-comment-dots me-1"></i>
                    <span data-reply-count th:text="${notice.replyCount}">0</span>
                </p>

                <div class="reply_list_area">
                <ul>
                  <li class="reply_list border-bottom">
                    <div class="d-flex justify-content-start align-items-start gap-2 py-2">
                      <div class="flex-grow-1">
                        <b>댓작성자</b>
                        <div class="replyContent">어쩌고저쩌고</div>
                      </div>
                      <div class="flex-shrink-1">
                        <div class="btn-group">
                          <button aria-expanded="false" class="btn btn-xs rounded-2 btn-outline-gray" data-bs-toggle="dropdown"
                                  type="button">
                            <i class="fa-solid fa-ellipsis"></i>
                          </button>
                          <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="">수정</a></li>
                            <li><a class="dropdown-item" href="">삭제</a></li>
                            <li><a class="btnReReplyWriteView dropdown-item">대댓글 달기</a></li>
                          </ul>
                        </div>
                      </div>
                    </div>
                    <div class="reply_depth2 ps-4">
                      <ul>
                        <li class="rerpley_list border-top">
                          <div class="d-flex justify-content-start align-items-start gap-2 py-2">
                            <div class="flex-grow-1">
                              <b>대댓작성자</b>
                              <div class="replyContent">어쩌고저쩌고</div>
                            </div>
                            <div class="flex-shrink-1">
                              <div class="btn-group">
                                <button aria-expanded="false" class="btn btn-xs rounded-2 btn-outline-gray"
                                        data-bs-toggle="dropdown" type="button">
                                  <i class="fa-solid fa-ellipsis"></i>
                                </button>
                                <ul class="dropdown-menu">
                                  <li><a class="dropdown-item" href="">수정</a></li>
                                  <li><a class="dropdown-item" href="">삭제</a></li>
                                </ul>
                              </div>
                            </div>
                          </div>
                        </li>
                        <li class="border-top">
                          <div class="d-flex justify-content-start align-items-start gap-2 py-2">
                            <div class="flex-grow-1">
                              <b>댓작성자</b>
                              <div class="replyContent">어쩌고저쩌고</div>
                            </div>
                            <div class="flex-shrink-1">
                              <div class="btn-group">
                                <button aria-expanded="false" class="btn btn-xs rounded-2 btn-outline-gray"
                                        data-bs-toggle="dropdown" type="button">
                                  <i class="fa-solid fa-ellipsis"></i>
                                </button>
                                <ul class="dropdown-menu">
                                  <li><a class="dropdown-item" href="">수정</a></li>
                                  <li><a class="dropdown-item" href="">삭제</a></li>
                                </ul>
                              </div>
                            </div>
                          </div>
                        </li>
                      </ul>
                    </div>
                  </li>
                  <li class="reply_list border-bottom">
                    <div class="d-flex justify-content-start align-items-start gap-2 py-2">
                      <div class="flex-grow-1">
                        <b>댓작성자</b>
                        <div class="replyContent">어쩌고저쩌고</div>
                      </div>
                      <div class="flex-shrink-1">
                        <div class="btn-group">
                          <button aria-expanded="false" class="btn btn-xs rounded-2 btn-outline-gray" data-bs-toggle="dropdown"
                                  type="button">
                            <i class="fa-solid fa-ellipsis"></i>
                          </button>
                          <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="">수정</a></li>
                            <li><a class="dropdown-item" href="">삭제</a></li>
                            <li><a class="btnReReplyWriteView dropdown-item">대댓글 달기</a></li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </li>
                  <li class="reply_list border-bottom">
                    <div class="d-flex justify-content-start align-items-start gap-2 py-2">
                      <div class="flex-grow-1">
                        <b>댓작성자</b>
                        <div class="replyContent">어쩌고저쩌고</div>
                      </div>
                      <div class="flex-shrink-1">
                        <div class="btn-group">
                          <button aria-expanded="false" class="btn btn-xs rounded-2 btn-outline-gray" data-bs-toggle="dropdown"
                                  type="button">
                            <i class="fa-solid fa-ellipsis"></i>
                          </button>
                          <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="">수정</a></li>
                            <li><a class="dropdown-item" href="">삭제</a></li>
                            <li><a class="btnReReplyWriteView dropdown-item">대댓글 달기</a></li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
                        <!--  댓글 페이징               -->
                <div class="mt-2">
                    <ul class="pagination replyPaging"></ul>
                </div>

                <div class="reply_write_area pt-3">
                <div class="mb-2">
                  <textarea class="form-control" id="replyText" name="replyText"
                            placeholder="댓글 내용을 입력해주세요(최대 1000자)"></textarea>
                </div>
                <div class="d-flex">
                  <button class="btnReplyRegister ms-auto btn btn-gray">댓글 쓰기</button>
                </div>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script layout:fragment="pagescript" th:inline="javascript">
    const bno = [[${notice.bno}]]; // 게시글 번호
    const replyList = document.querySelector(".reply_list_area ul");
    const replyText = document.querySelector("#replyText");
    const btnWrite = document.querySelector(".btnReplyRegister");
    const replyPaging = document.querySelector(".replyPaging");
    let page = 1;
    let size = 5;

    // 댓글 수 표시 갱신
    function setReplyCount(n){
        document.querySelectorAll('[data-reply-count]')
            .forEach(el => el.textContent = String(n ?? 0));
    }

    // 댓글 목록 출력
    function printReplies(page, size){
        axios.get(`/noticereplies/list/${bno}?page=${page}&size=${size}`)
            .then(res=>{
                const data = res.data;
                const dtoList = data.dtoList || [];

                if (typeof data.total === 'number') setReplyCount(data.total);

                let str = "";
                if(dtoList.length === 0){
                    str = `<li class="border-bottom py-3 text-secondary">등록된 댓글이 없습니다.</li>`;
                } else {
                    dtoList.forEach(dto=>{
                        str += `
                        <li class="reply_list border-bottom d-flex justify-content-between" data-rno="${dto.rno}">
                            <div>
                                <b>${dto.nickname || '작성자'}</b><small class="text-muted ms-2">
                                ${dto.regDate} ${dto.updateDate ? `<small class="text-muted ms-2">(수정됨 ${dto.updateDate})</small>` : ''}
                                </small><br> ${dto.content}
                            </div>

                           <div class="flex-shrink-1">
                              <div class="btn-group">
                                <button class="btn btn-xs rounded-2 btn-outline-gray"
                                        type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                  <i class="fa-solid fa-ellipsis"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                  <li><a class="dropdown-item btnEdit" href="#">수정</a></li>
                                  <li><a class="dropdown-item btnDel" href="#">삭제</a></li>
                                </ul>
                              </div>
                            </div>

                        </li>`;
                    });
                }
                replyList.innerHTML = str;
                printPages(data); //  페이징 표시 추가
            })
            .catch(err=>{
                console.error(err);
                replyList.innerHTML = `<li class="border-bottom py-3 text-secondary">댓글을 불러오는 중 오류가 발생했습니다.</li>`;
            });
    }

    // 페이지 표시
    function printPages(data){
        if(!data || !data.total){ replyPaging.innerHTML = ""; return; }

        let html = "";
        if (data.prev){
            html += `<li class="page-item"><a class="page-link" data-page="${data.start-1}">«</a></li>`;
        }
        for (let i = data.start; i <= data.end; i++){
            html += `<li class="page-item ${i===data.page?'active':''}">
                        <a class="page-link" data-page="${i}">${i}</a>
                     </li>`;
        }
        if (data.next){
            html += `<li class="page-item"><a class="page-link" data-page="${data.end+1}">»</a></li>`;
        }
        replyPaging.innerHTML = html;
    }

    // 페이지 클릭 이벤트
    replyPaging?.addEventListener("click", (e)=>{
        e.preventDefault();
        const a = e.target.closest("a");
        if(!a) return;
        page = Number(a.dataset.page);
        printReplies(page, size);
    });

    // 댓글 등록
    btnWrite.addEventListener("click", ()=>{
        const content = replyText.value.trim();
        if(!content) return alert("내용을 입력하세요!");
        axios.post(`/noticereplies/`, { bno, content })
            .then(res=>{
                alert("댓글이 등록되었습니다!");
                replyText.value = "";
                printReplies(1, size);
            })
            .catch(err=>{
                alert("등록 실패!");
                console.error(err);
            });
    });

    // 수정/삭제
    replyList.addEventListener("click", e=>{
        const li = e.target.closest("li.reply_list");
        const rno = li?.dataset?.rno;
        if(!rno) return;

        // 수정
        if(e.target.classList.contains("btnEdit")){
            const oldContent = li.querySelector(".replyContent")?.textContent.trim() ?? "";
            const newContent = prompt("새 내용 입력:", oldContent);
            if(!newContent || newContent === oldContent) return;
            axios.put(`/noticereplies/${rno}`, { content: newContent })
                .then(()=>{ alert("수정 완료"); printReplies(page, size); });
        }

        // 삭제
        if(e.target.classList.contains("btnDel")){
            if(!confirm("삭제하시겠습니까?")) return;
            axios.post(`/noticereplies/delete/${rno}`)
                .then(()=>{ alert("삭제 완료"); printReplies(page, size); });
        }
    });

    // 초기 로딩
    printReplies(page, size);
</script>
