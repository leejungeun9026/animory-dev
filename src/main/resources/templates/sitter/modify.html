<!DOCTYPE html>
<html lang="en" layout:decorate="~{include/user}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      xmlns:th="http://www.thymeleaf.org">

<div layout:fragment="content">
  <!-- /* view 화면 html 코드 작성 부분 */ -->
  <div class="page_title mb-4">
    <a class="d-inline-flex align-items-baseline" href="/sitter/list">
      <small class="text-danger">돌보미 게시판 <i class="fa-solid fa-chevron-right fs-xs"></i></small>
    </a>
    <h3 class="memomentKkukkkuk fw-normal mt-2">게시글 수정</h3>
  </div>
  <div class="board_area">
    <form action="/sitter/modify" enctype="multipart/form-data" method="post">
      <input type="hidden" name="bno" th:value="${board.bno}">
      <input type="hidden" name="category" th:value="${board.category}">
      <input type="hidden" name="username" th:value="${board.username}">
      <div class="d-flex gap-2 mb-2">
        <select class="form-select w-auto" id="category" aria-label="구인구직" disabled>
          <option value="구해요" th:selected="${board.category == '구해요'}">구하고 싶어요</option>
          <option value="일해요" th:selected="${board.category == '일해요'}">일하고 싶어요</option>
        </select>
        <select class="form-select w-auto" name="state" id="state" aria-label="상태" >
        </select>
      </div>
      <div class="mb-2">
        <select class="form-select" id="petInfo" name="petInfo">
          <option value="dog" th:selected="${board.petInfo == 'dog'}">강아지</option>
          <option value="cat" th:selected="${board.petInfo == 'cat'}">고양이</option>
        </select>
      </div>
      <div class="mb-2">
        <div class="d-flex align-items-center gap-1">
          <select class="form-select" id="sido" name="sido" required>
            <option data-sido-id="" value="">시/도</option>
          </select>
          <select class="form-select" disabled id="sigungu" name="sigungu" required>
            <option value="">시/군/구</option>
          </select>
        </div>
      </div>
      <div class="mb-2">
        <input aria-label="제목" class="form-control" name="title" placeholder="제목을 입력해주세요" required type="text" th:value="${board.title}">
      </div>
      <div class="mb-2">
        <textarea aria-label="내용"  class="form-control" cols="30" id="content" name="content" placeholder="시간과 장소 및 급여를 자세히 알려주세요!(최대 1000자)"
                  required rows="10">[[${board.content}]]</textarea>
      </div>
      <div class="mb-3">
        <input class="form-control" multiple name="files" type="file">
        <input type="text" name="deleteFileUuid" id="deleteFileUuid">
        <ul id="fileList" class="list-group mt-2" th:if="${board.fileDTOs != null && board.fileDTOs.size > 0}">
          <li class="list-group-item px-2" th:each="file:${board.fileDTOs}">
            <div class="d-flex align-items-center gap-2">
              <div class="img_wrap thumb_40x40 border-1">
                <img th:src="|/sitter/view/s_${file.uuid}_${file.filename}|">
              </div>
              <div>
                <p>[[${file.getFilename()}]]</p>
                <input type="text" name="keepFileUuid" th:value="${file.uuid}">
              </div>
              <div class="btn_wrap ms-auto">
                <button class="btnDeleteFile btn btn-xs btn-danger" th:data-uuid="${file.uuid}">
                  <i class="fa-solid fa-xmark"></i>
                </button>
              </div>
            </div>
          </li>
        </ul>
      </div>
      <div class="button_wrap">
        <div class="row g-2">
          <div class="col-6 col-md-auto ms-md-auto">
            <a class="btn btn-lg btn-gray w-100" th:href="|@{/sitter/view(bno=${board.bno}, mode='0')}&${sitterBoardPageRequestDTO.link}|">취소</a>
          </div>
          <div class="col-6 col-md-auto">
            <button class="btn btn-lg btn-main w-100">저장</button>
          </div>
        </div>
      </div>
    </form>
  </div>
  <!-- /* //view 화면 html 코드 작성 끝 */ -->
</div>

<script layout:fragment="pagescript" th:inline="javascript">
    /////// 카테고리 및 타입 가져오기 ///////
    const readCate = [[${board.category}]]
    const readState = [[${board.state}]]
    const state = document.getElementById("state")
    const petInfo = document.getElementById("petInfo")
    console.log(readCate)
    if(readCate==="구해요"){
        petInfo.classList.remove("d-none")
        petInfo.classList.add("d-block")
        if(readState === "구인중") {
            state.innerHTML = `<option value="구인중" selected>구인중</option>
                              <option value="구인완료">구인완료</option>`
        } else {
            state.innerHTML = `<option value="구인중">구인중</option>
                              <option value="구인완료" selected>구인완료</option>`
        }
    } else if(readCate==="일해요"){
        petInfo.classList.remove("d-block")
        petInfo.classList.add("d-none")
        if(readState === "구직중") {
            state.innerHTML = `<option value="구직중" selected>구직중</option>
                              <option value="구직완료">구직완료</option>`
        } else {
            state.innerHTML = `<option value="구직중" >구직중</option>
                              <option value="구직완료" selected>구직완료</option>`
        }
    }



    /////// 사용자 정보 - 시도,시군구 정보 초기화 ///////
    const sido = document.querySelector("#sido")
    const sigungu = document.querySelector("#sigungu")

    async function loadSido() {
        const readSido = [[${board.sido}]]
        const readSigungu = [[${board.sigungu}]]
        const {data: sidoList} = await axios.get('/api/regions/sido');
        sido.innerHTML = `<option value="">시/도</option>` +
            sidoList.map(s =>
                `<option value="${s.name}" data-sido-id="${s.id}" ${s.name === readSido ? 'selected' : ''}>${s.name}</option>`
            ).join('');
        const selectedOption = sido.selectedOptions[0]; // 선택된 <option> 요소
        const sidoId = selectedOption.dataset.sidoId;       // data-sidoid 값 읽기

        // loadSigungu랑 거의 같음
        // memberSiGungu 를 가지고 selected 하는 부분만 다름
        if (!sidoId) {
            sigungu.innerHTML = '<option value="">시/군/구</option>';
            sigungu.disabled = true;
            return;
        }
        const {data: sigunguList} = await axios.get('/api/regions/sigungu', {params: {sidoId}});
        sigungu.innerHTML = '<option value="">시/군/구</option>' +
            sigunguList.map(g => `<option value="${g.name}" ${g.name === readSigungu ? 'selected' : ''}>${g.name}</option>`).join('');
        sigungu.disabled = false;
    }

    async function loadSigungu(sidoId) {
        if (!sidoId) {
            sigungu.innerHTML = '<option value="">시/군/구</option>';
            sigungu.disabled = true;
            return;
        }
        const {data} = await axios.get('/api/regions/sigungu', {params: {sidoId}});
        sigungu.innerHTML = '<option value="">시/군/구</option>' +
            data.map(g => `<option value="${g.name}">${g.name}</option>`).join('');
        sigungu.disabled = false;
    }

    sido.addEventListener('change', (e) => {
        const selectedOption = e.target.selectedOptions[0]; // 선택된 <option> 요소
        const sidoId = selectedOption.dataset.sidoId;       // data-sidoid 값 읽기
        loadSigungu(sidoId);
    });

    loadSido()




    /////// 첨부파일 삭제 ///////
    const fileList = document.getElementById("fileList")
    const deleteFileUuidInput = document.getElementById("deleteFileUuid")
    const deleted = new Set()

    fileList.addEventListener("click", function(e){
        const btn = e.target.closest(".btnDeleteFile")
        if(!btn) return
        const uuid = btn.dataset.uuid
        deleted.add(uuid)

        btn.closest("li").remove()
        deleteFileUuidInput.value = Array.from(deleted).join(',')
    })
</script>