<!DOCTYPE html>
<html lang="en" layout:decorate="~{include/user}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">

<div layout:fragment="content">
    <!-- /* view 화면 html 코드 작성 부분 */ -->
    <div class="page_title mb-4">
        <a href="/free/list" class="d-inline-flex align-items-baseline">
            <small class="text-danger">커뮤니티<i class="fa-solid fa-chevron-right fs-xs"></i></small>
        </a>
        <h3 class="memomentKkukkkuk fw-normal mt-2">게시글 보기</h3>
    </div>
    <div class="board_area">
        <div class="card rounded-3">
            <div class="card-body">
                <table class="table table-borderless">
                    <thead>
                    <tr>
                        <td class="tb_title border-bottom pb-3 px-0">
                            <div class="d-flex gap-2 flex-nowrap align-items-end mb-2">
                                <div class="d-flex gap-2 flex-nowrap align-items-center">
                                    <p th:text="${freeBoard.btype}" class="badge"
                                       th:classappend="${freeBoard.btype == '자유'} ? ' badge-success' : (${freeBoard.btype == '정보'} ? ' badge-info' : ' badge-secondary')">
                                    </p>
                                </div>
                                <div class="d-flex gap-1 flex-nowrap ms-auto">
                                    <div class="col-6 col-md-auto ms-md-auto">
                                        <a class="btn btn-gray" href="/free/list">목록</a>
                                    </div>
<!--                                <span sec:authorize="isAuthenticated()"-->
<!--                                          th:if="${#authentication.principal.username == freeBoard.username}">-->
                                    <a th:href="|@{/free/modify(bno=${freeBoard.bno},mode=2)}|" class="btn btn-info">수정</a>
                                    <a th:href="@{/free/remove(bno=${freeBoard.bno},mode=2)}" class="btn btn-danger">삭제</a>
<!--                                </span>-->
                                </div>
                                <!-- // 로그인 사용자 == 글작성자 같을 경우만 노출 끝 -->

                            </div>
                            <h4 class="py-2" th:text="${freeBoard.title}"></h4>
                            <div class="d-flex gap-2 flex-nowrap text-secondary">
                                <p>[[${#temporals.format(freeBoard.updateDate, 'yyyy.MM.dd HH:mm')}]]</p>
                                <p class="ms-auto"><i class="fa-regular fa-eye me-1"></i>[[${freeBoard.readcount}]]</p>
                                <p id="likeBtn">
                                    <i id="likeIcon"
                                       th:class="${freeBoard.likecount >= 1} ? 'fa-solid fa-heart me-1 text-danger' : 'fa-regular fa-heart me-1 text-danger'"></i>
                                    <span id="likeCount">[[${freeBoard.likecount}]]</span>
                                </p>
                                <p><i class="fa-regular fa-comment-dots me-1"></i>8</p>
                            </div>
                        </td>
                    </tr>
                    </thead>
                </table>
                    <tbody>
                    <!-- 첨부파일이 있으면 노출 -->
                    <tr class="mb-3">
                        <td>
                            <span class="input-group-text">첨부 이미지</span>
                            <div class="col" th:if="${freeBoard.freeFileDTOS !=null && freeBoard.freeFileDTOS.size()>0}">
                                <div class="container-fluid d-flex uploadResult" style="flex-wrap: wrap">
                                    <img class="mb-3" th:each="file:${freeBoard.freeFileDTOS}" th:src="|/uploads/free/s_${file.uuid}_${file.filename}|">
                                </div>
                            </div>
                        </td>
                    <tr>
                        <td class="px-0 py-3">
                            <div class="tb_content">[[${freeBoard.content}]]</div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- /* //view 화면 html 코드 작성 끝 */ -->
</div>

<script layout:fragment="pagescript" th:inline="javascript">
    /////// 대댓글 textarea toggle ///////
    const btnReReplyWriteViews = document.querySelectorAll(".btnReReplyWriteView")
    function reReplyStr() {
        return `<div class="reReplyWriteArea">
                <div class="d-flex justify-content-start align-items-start gap-2 py-2">
                  <div class="flex-grow-1">
                    <div class="mb-2">
                      <textarea name="reReplyText" id="reReplyText" class="form-control" placeholder="대댓글 내용을 입력해주세요(최대 1000자)"></textarea>
                    </div>
                    <div class="d-flex">
                      <button class="btnReReplyRegister ms-auto btn btn-main">대댓글 쓰기</button>
                    </div>
                  </div>
                  <div class="flex-shrink-1">
                    <button class="btnReReplyWriteClose btn btn-xs btn-outline-danger">
                      <i class="fa-solid fa-xmark"></i>
                    </button>
                  </div>
                </div>
              </div>`
    }

    btnReReplyWriteViews.forEach(btn => {
        btn.addEventListener("click", function(e){
            e.preventDefault()
            const li = e.target.closest("li.reply_list")
            console.log(li)
            // 대댓글 영역이 없으면 만들고 변수 초기화
            if (li.querySelector(".reply_depth2") == null) {
                li.insertAdjacentHTML("beforeend", `<div class="reply_depth2 ps-4"></div>`)
            }
            const depth2 = li.querySelector(".reply_depth2")

            // 대댓글창이 이미 열려있으면 return, 아니면 추가하기
            if (depth2.querySelector(".reReplyWriteArea") != null) {
                return
            }
            depth2.insertAdjacentHTML("beforeend", reReplyStr())

            const btnReReplyWriteClose = depth2.querySelector(".btnReReplyWriteClose")
            btnReReplyWriteClose.addEventListener("click", () => {
                btnReReplyWriteClose.closest(".reReplyWriteArea").remove()
            })
        })
    })

    //좋아요 버튼 누르면 recommend 수 증가
    $(document).ready(function(){
        // likeBtn을 누르면 함수
        $('#likeBtn').on('click', function (){
            const bno = [[${freeBoard.bno}]]

            $.ajax({
                url : "/free/like",
                type : "GET",
                data : { bno : bno},
                success : function(response){
                    console.log(response);
                    // 업데이트 된 레코맨드 수 가져오기
                    var likecount = response.likecount;
                    $('#likeCount').text(likecount);

                    //추천 수가 0에서 1이 되면 하트 아이콘이 빈하트 -> 꽉 찬 하트로 변화
                    if(likecount > 0){
                        $('#likeIcon').removeClass('fa-regular').addClass('fa-solid');
                    } else {
                        $('#likeIcon').removeClass('fa-solid').addClass('fa-regular');
                    }
                }
            })

        })
    })


</script>