<!DOCTYPE html>
<html lang="en" layout:decorate="~{include/user}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<div layout:fragment="main_visual">
  <section class="main_visual">
    <div class="swiper mvSwiper">
      <ul class="swiper-wrapper">
        <li class="swiper-slide">
          <a href="">
            <img alt="" src="/images/TPL04990_Banner_Template.jpg">
          </a>
        </li>
        <li class="swiper-slide">
          <a href="">
            <img alt="" src="/images/TPL00669.jpg">
          </a>
        </li>
        <li class="swiper-slide">
          <a href="">
            <img alt="" src="/images/TPL04605_Banner_Template.jpg">
          </a>
        </li>
        <li class="swiper-slide">
          <a href="">
            <img alt="" src="/images/TPL00981.jpg">
          </a>
        </li>
        <li class="swiper-slide">
          <a href="">
            <img alt="" src="/images/TPL06363_Banner_Template.jpg">
          </a>
        </li>
        <li class="swiper-slide">
          <a href="">
            <img alt="" src="/images/TPL07070_Banner_Template.jpg">
          </a>
        </li>
        <li class="swiper-slide">
          <a href="">
            <img alt="" src="/images/TPL08674_Banner_Template.jpg">
          </a>
        </li>
        <li class="swiper-slide">
          <a href="">
            <img alt="" src="/images/TPL10689_Banner_Template.jpg">
          </a>
        </li>
        <li class="swiper-slide">
          <a href="">
            <img alt="" src="/images/TPL12238_Banner_Template.jpg">
          </a>
        </li>
      </ul>
    </div>
  </section>
</div>
<div layout:fragment="content">
  <!-- NOTICE BOARD -->
  <section class="notice_section mb-3 mb-md-4">
    <div class="card bg-primary bg-opacity-10 rounded-4 border-0">
      <div class="card-body p-4 h-100">
        <div class="row gx-3 gy-2 align-items-baseline">
          <div class="col-12 col-md-auto">
            <h4 class="memomentKkukkkuk fw-normal"><i class="fa-solid fa-volume-high text-primary"></i> 공지사항</h4>
          </div>
          <div class="col-12 com-md">
            <div class="swiper noticeSwiper">
              <ul class="swiper-wrapper">
                <li class="swiper-slide" th:if="${#lists.isEmpty(noticeBoard)}">
                  <p>공지사항이 없어요</p>
                </li>
                <li class="swiper-slide" th:each="board:${noticeBoard}" th:unless="${#lists.isEmpty(noticeBoard)}">
                  <div class="d-flex gap-2 align-items-center">
                    <div class="flex-grow-1">
                      <a th:href="@{/notice/view(bno=${board.bno})}">
                        <h6 class="text-overflew-line-1">[[${board.title}]]</h6>
                      </a>
                    </div>
                    <div class="ms-auto flex-shrink-1">
                      <div class="d-flex gap-2 flex-nowrap text-secondary">
                        <p class="text-danger text-nowrap">[[${#temporals.format(board.regDate, 'MM-dd')}]]</p>
                        <p class="text-nowrap"><i class="fa-regular fa-eye me-1"></i>[[${board.readCount}]]</p>
                        <p class="text-nowrap"><i class="fa-regular fa-comment-dots me-1"></i>[[${board.replyCount}]]</p>
                      </div>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- // NOTICE BOARD 끝 -->

  <!-- FREE BOARD -->
  <section class="main_board_list col mb-3 mb-md-4">
    <div class="card rounded-4 h-100">
      <div class="card-body p-0 pb-4">
        <div class="section_title mb-1 mb-md-2 pt-4 px-4">
          <h4 class="memomentKkukkkuk fw-normal"><i class="fa-solid fa-paw text-primary"></i> 커뮤니티</h4>
          <small class="text-secondary">반려생활 이모저모, 우리 아이 자랑해요</small>
        </div>
        <div class="swiper freeSwiper">
          <ul class="swiper-wrapper">
            <li class="swiper-slide" th:if="${#lists.isEmpty(freeBoard)}">
              <div class="py-2">
                <p class="text-secondary">게시글이 없어요</p>
              </div>
            </li>
            <li class="swiper-slide" th:each="board:${freeBoard}" th:unless="${#lists.isEmpty(freeBoard)}">
              <div class="item_card">
                <a class="card__img" th:href="@{/free/view(bno=${board.bno}, mode=1)}">
                  <div class="category_badge">
                    <p th:if="${board.btype == '자유'}" class="badge badge-success">&#x1F4AC; 자유수다</p>
                    <p th:if="${board.btype == '정보'}" class="badge badge-warning">&#x1F4A1; 정보공유</p>
                  </div>
                  <div class="options">
                    <div class="d-flex gap-2 flex-nowrap text-white">
                      <p class="text-nowrap"><i class="fa-regular fa-eye me-1"></i>[[${board.readcount}]]</p>
                      <p class="text-nowrap" th:if="${board.likecount >= 1}"><i class="fa-solid fa-heart me-1 text-danger"></i>[[${board.likecount}]]</p>
                      <p class="text-nowrap" th:if="${board.likecount == 0}"><i class="fa-regular fa-heart me-1 text-danger"></i>[[${board.likecount}]]</p>
                      <p class="text-nowrap"><i class="fa-regular fa-comment-dots me-1"></i>[[${board.replycount}]]</p>
                    </div>
                  </div>
                  <div class="no_thumb" th:if="${board.thumbnailMain == null}">
                    <i class="fa-solid fa-paw"></i>
                  </div>
                  <img  th:if="${board.thumbnailMain != null}" th:src="@{/uploads/free/{thumb}(thumb=${board.thumbnailMain})}">
                </a>
                <div class="card__body">
                  <a th:href="@{/free/view(bno=${board.bno}, mode=1)}">
                    <h5 class="item_title mb-1">
                      [[${board.title}]]
                    </h5>
                    <div class="d-flex gap-2 flex-nowrap text-secondary">
                      <p class="text-nowrap">[[${board.nickname}]]</p>
                      <p class="text-nowrap">[[${#temporals.format(board.regDate, 'MM-dd')}]]</p>
                    </div>
                  </a>
                </div>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div class="card-footer bg-transparent py-3 text-center">
        <a href="/free/list">커뮤니티 더보기<i class="fa-solid fa-chevron-right ms-1"></i></a>
      </div>
    </div>
  </section>
  <!-- // FREE BOARD END -->


  <div class="row row-cols-1 row-cols-md-2">
    <!-- MATE BOARD -->
    <section class="main_board_list col mb-3 mb-md-4">
      <div class="card rounded-4 h-100">
        <div class="card-body p-4">
          <div class="section_title mb-1 mb-md-2">
            <h4 class="memomentKkukkkuk fw-normal"><i class="fa-solid fa-dog text-primary"></i> 산책메이트</h4>
            <small class="text-secondary">같이 산책나가요!</small>
          </div>
          <div class="section_content">
            <ul>
              <li th:if="${#lists.isEmpty(mateBoard)}">
                <div class="py-2">
                  <p class="text-secondary">게시글이 없어요</p>
                </div>
              </li>
              <li th:each="board:${mateBoard}" th:unless="${#lists.isEmpty(mateBoard)}">
                <div class="border-bottom">
                  <div class="row py-3">
                    <div class="col-12">
                      <div class="d-flex gap-2 flex-nowrap mb-1">
                        <p class="badge badge-gray">[[${board.sido}]] / [[${board.sigungu}]]</p>
                        <p th:if="${board != null and board.category == '1:1 모집'}" class="badge badge-warning">
                          &#x1F464; [[${board.category}]]
                        </p>
                        <p th:if="${board != null and board.category == '그룹 모집'}" class="badge badge-info">
                          &#x1F465; [[${board.category}]]
                        </p>
                      </div>
                      <a th:href="@{/mate/view(bno=${board.bno}, mode=1)}"  class="d-inline-flex justify-content-start align-items-center gap-1 flex-nowrap w-100 mb-1">
                        <!-- 신청마감일 표시 블록 -->
                        <p th:if="${board.dueDate != null && !board.expired}" class="badge badge-danger">[[${board.dueDisplay}]] 까지</p>
                        <p th:if="${board.dueDate != null && board.expired}" class="badge badge-danger">마감</p>
                        <h6 class="text-overflew-line-1">[[${board.title}]]</h6>
                      </a>
                    </div>
                    <div class="col">
                      <div class="d-flex gap-2 flex-nowrap text-secondary">
                        <p class="text-nowrap">[[${board.nickname}]]</p>
                        <p class="text-nowrap">[[${#temporals.format(board.regDate, 'MM-dd')}]]</p>
                      </div>
                    </div>
                    <div class="col-auto">
                      <div class="d-flex gap-2 flex-nowrap text-secondary">
                        <p class="text-nowrap"><i class="fa-regular fa-eye me-1"></i>[[${board.readCount}]]</p>
                        <p class="text-nowrap" th:if="${board.likecount >= 1}"><i class="fa-solid fa-heart me-1 text-danger"></i>[[${board.likecount}]]</p>
                        <p class="text-nowrap" th:if="${board.likecount == 0}"><i class="fa-regular fa-heart me-1 text-danger"></i>[[${board.likecount}]]</p>
                        <p class="text-nowrap"><i class="fa-regular fa-comment-dots me-1"></i>[[${board.replyCount}]]</p>
                      </div>
                    </div>
                  </div>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div class="card-footer bg-transparent py-3 text-center">
          <a href="/mate/list">산책메이트 더보기<i class="fa-solid fa-chevron-right ms-1"></i></a>
        </div>
      </div>
    </section>
    <!-- // MATE BOARD END -->

    <!-- SITTER BOARD -->
    <section class="main_board_list col mb-3 mb-md-4">
      <div class="card rounded-4 h-100">
        <div class="card-body p-4">
          <div class="section_title mb-1 mb-md-2">
            <h4 class="memomentKkukkkuk fw-normal"><i class="fa-solid fa-bowl-food text-primary"></i> 돌보미</h4>
            <small class="text-secondary">시터가 필요한 누구나, 시터로 일하고싶은 누구나</small>
          </div>
          <div class="section_content">
            <ul>
              <li th:if="${#lists.isEmpty(sitterBoard)}">
                <div class="py-2">
                  <p class="text-secondary">게시글이 없어요</p>
                </div>
              </li>
              <li th:each="board:${sitterBoard}" th:unless="${#lists.isEmpty(sitterBoard)}">
                <div class="border-bottom">
                  <div class="row py-3">
                    <div class="col-12">
                      <div class="d-flex gap-2 flex-nowrap mb-1">
                        <p th:if="${board.category == '구해요'}" class="badge badge-warning">&#x1F440; 돌봄 구해요</p>
                        <p th:if="${board.category == '일해요'}" class="badge badge-danger">&#x1F525; 돌봄 일해요</p>
                        <p th:class="${board.state == '구인중' or board.state == '구직중' ? 'badge badge-info':'badge badge-success'}">[[${board.state}]]</p>
                        <p th:text="${board.petInfo == 'dog' ? '강아지' : '고양이'}" class="badge badge-outline-secondary"></p>
                      </div>
                      <a th:href="@{/sitter/view(bno=${board.bno}, mode=1)}" class="d-inline-flex align-items-center gap-1 flex-nowrap w-100 mb-1">
                        <p class="badge badge-gray">[[${board.sido}]]/[[${board.sigungu}]]</p>
                        <h6 class="text-overflew-line-1">[[${board.title}]]</h6>
                      </a>
                    </div>
                    <div class="col">
                      <div class="d-flex gap-2 flex-nowrap text-secondary">
                        <p class="text-nowrap">[[${board.nickname}]]</p>
                        <p class="text-nowrap">[[${#temporals.format(board.regDate, 'MM-dd')}]]</p>
                      </div>
                    </div>
                    <div class="col-auto">
                      <div class="d-flex gap-2 flex-nowrap text-secondary">
                        <p class="text-nowrap"><i class="fa-regular fa-eye me-1"></i>[[${board.readCount}]]</p>
                        <p class="text-nowrap"><i class="fa-regular fa-comment-dots me-1"></i>[[${board.replyCount}]]</p>
                      </div>
                    </div>
                  </div>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div class="card-footer bg-transparent py-3 text-center">
          <a href="/sitter/list">돌보미 더보기<i class="fa-solid fa-chevron-right ms-1"></i></a>
        </div>
      </div>
    </section>
    <!-- // SITTER BOARD END -->
  </div>

  <!-- SPR BOARD -->
  <section class="main_board_list col mb-3 mb-md-4">
    <div class="card rounded-4 h-100">
      <div class="card-body p-4">
        <div class="section_title mb-1 mb-md-2">
          <h4 class="memomentKkukkkuk fw-normal"><i class="fa-solid fa-bag-shopping text-primary"></i> 사고팔개</h4>
          <small class="text-secondary">필요없는 물건은 나누고, 공동구매로 저렴하게</small>
        </div>
        <div class="section_content">
          <ul>
            <li th:if="${#lists.isEmpty(sprBoard)}">
              <div class="py-2">
                <p class="text-secondary">게시글이 없어요</p>
              </div>
            </li>
            <li th:each="board:${sprBoard}" th:unless="${#lists.isEmpty(sprBoard)}">
              <div class="border-bottom">
                <div class="row py-3">
                  <div class="col-12">
                    <div class="mb-1">
                      <div class="d-flex gap-2 flex-nowrap mb-1">
                        <p th:if="${board.category == '신고'}" class="badge text-bg-danger">&#x1F6AB; [[${board.category}]]</p>
                        <p th:if="${board.category == '공구'}" class="badge badge-warning">&#x1F6D2; [[${board.category}]]</p>
                        <p th:if="${board.category == '나눔'}" class="badge badge-warning">&#x1F381; [[${board.category}]]</p>
                        <!-- 나눔 / 공구 카테고리일 때 진행중 / 완료 표시 뱃지 -->
                        <p class="badge badge-info" th:if="${board.category == '나눔' || board.category == '공구'} and ${board.complete == false}">
                          [[${board.category}]]중
                        </p>
                        <p class="badge badge-success" th:if="${board.category == '나눔' || board.category == '공구'} and ${board.complete == true}">
                          [[${board.category}]]완료
                        </p>
                      </div>
                      <div class="d-flex gap-2 flex-nowrap mb-2" th:if="${board.category == '나눔'}">
                        <!-- 나눔 카테고리일 때 시도 시군구 표시 뱃지 -->
                        <p class="badge badge-gray">[[${board.sido}]] / [[${board.sigungu}]]</p>
                      </div>
                      <a th:href="@{/spr/view(bno=${board.bno}, mode=1)}" class="d-inline-flex justify-content-start align-items-center gap-1 flex-nowrap w-100 mb-1">
                        <span class="text-nowrap badge badge-danger" th:if="${board.category == '공구'} and ${board.complete == false}">[[${board.dueDate}]]까지</span>
                        <span class="text-nowrap badge badge-danger" th:if="${board.category == '공구'} and ${board.complete == true}">마감</span>
                        <h6 class="text-overflew-line-1">[[${board.title}]]</h6>
                      </a>
                    </div>
                  </div>
                  <div class="col">
                    <div class="d-flex gap-2 flex-nowrap text-secondary">
                      <p class="text-nowrap">[[${board.author}]]</p>
                      <p class="text-nowrap">[[${#temporals.format(board.regDate, 'MM-dd')}]]</p>
                    </div>
                  </div>
                  <div class="col-auto">
                    <div class="d-flex gap-2 flex-nowrap text-secondary">
                      <p class="text-nowrap"><i class="fa-regular fa-eye me-1"></i>[[${board.readcount}]]</p>
                      <p class="text-nowrap" th:if="${board.recommend >= 1}"><i class="fa-solid fa-heart me-1 text-danger"></i>[[${board.recommend}]]</p>
                      <p class="text-nowrap" th:if="${board.recommend == 0}"><i class="fa-regular fa-heart me-1 text-danger"></i>[[${board.recommend}]]</p>
                      <p class="text-nowrap"><i class="fa-regular fa-comment-dots me-1"></i>[[${board.replyCount}]]</p>
                    </div>
                  </div>
                </div>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div class="card-footer bg-transparent py-3 text-center">
        <a href="/spr/list">사고팔개 더보기<i class="fa-solid fa-chevron-right ms-1"></i></a>
      </div>
    </div>
  </section>
  <!-- // SPR BOARD END -->

  <section class="main_board_list col mt-3 mt-md-4">
    <div class="card rounded-4 h-100">
      <div class="card-body p-4">
        <div class="section_title mb-2 mb-md-3">
          <h4 class="memomentKkukkkuk fw-normal"><i class="fa-solid fa-hospital text-primary"></i> 동물병원 찾기</h4>
        </div>
        <div class="row g-3">
          <div class="col-12 col-lg-7 col-xl-8">
            <div id="map" class="kakaomap"></div>
          </div>
          <div class="col-12 col-lg-5 col-xl-4">
            <ul id="mapList"></ul>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<script layout:fragment="pagescript" th:inline="javascript">
    ////////// swiper 관련 //////////
    var swiper = new Swiper(".mvSwiper", {
        slidesPerView: 1,
        loop: true,
        autoplay: {
            delay: 2500,
            disableOnInteraction: false,
        },
        breakpoints: {
            768: {
                slidesPerView: "auto",
                centeredSlides: true
            }
        }
    });

    var swiper = new Swiper(".noticeSwiper", {
        direction: "vertical",
        loop: true,
        autoplay: {
            delay: 2500,
            disableOnInteraction: false,
        }
    });

    var swiper = new Swiper(".freeSwiper", {
        slidesPerView: "auto",
        spaceBetween: 16,
        pagination: {
            clickable: true,
        },
    });

    ////////// kakaomap //////////
    // ===== 0) 좌표계 정의 =====
    proj4.defs("EPSG:5174",
        "+proj=tmerc +lat_0=38 +lon_0=127 +k=1 " +
        "+x_0=200000 +y_0=500000 +ellps=bessel " +
        "+towgs84=147,-507,-687,0,0,0,0 +units=m +no_defs"
    );
    proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs");

    // 거리 계산 함수는 그대로 사용
    function distance(center, position) {
        const lat1 = center.getLat(), lng1 = center.getLng();
        const lat2 = position.getLat(), lng2 = position.getLng();
        const R = 6371000;
        const toRad = Math.PI / 180;
        const dLat = (lat2 - lat1) * toRad;
        const dLng = (lng2 - lng1) * toRad;
        const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(lat1 * toRad) * Math.cos(lat2 * toRad) *
            Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    document.addEventListener("DOMContentLoaded", () => {
        // ===== 1) 지도 초기화 =====
        const mapContainer = document.getElementById('map');
        const map = new kakao.maps.Map(mapContainer, {
            center: new kakao.maps.LatLng(35.157744, 129.059039),
            level: 5
        });

        var mapTypeControl = new kakao.maps.MapTypeControl();
        map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

        var zoomControl = new kakao.maps.ZoomControl();
        map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);


        // (선택) 클러스터러 쓰고 싶으면 여기서 생성
        const clusterer = new kakao.maps.MarkerClusterer({
            map: map,
            averageCenter: true,
            minLevel: 5
        });

        const listEl = document.getElementById('mapList');
        let markerModels = [];   // { marker, overlay, data }
        let activeOverlay = null;

        function closeOverlay() {
            if (activeOverlay) {
                activeOverlay.setMap(null);
                activeOverlay = null;
            }
        }

        function clearMarkers() {
            markerModels.forEach(m => {
                m.marker.setMap(null);
                m.overlay.setMap(null);
            });
            markerModels = [];

            if (clusterer) {
                clusterer.clear();
            }
        }

        // ✅ 현재 지도 영역 기준으로 서버에서 병원 조회
        async function loadHospitalsInBounds() {
            const bounds = map.getBounds();
            const sw = bounds.getSouthWest(); // 남서쪽 (minLat, minLng)
            const ne = bounds.getNorthEast(); // 북동쪽 (maxLat, maxLng)

            // kakao map은 WGS84(4326) → DB는 5174라고 가정
            // SW, NE 를 5174 로 변환
            const [minLng, minLat] = proj4("EPSG:4326", "EPSG:5174", [sw.getLng(), sw.getLat()]);
            const [maxLng, maxLat] = proj4("EPSG:4326", "EPSG:5174", [ne.getLng(), ne.getLat()]);

            // 서버에서 이 범위 안에 있는 병원만 가져옴
            const response = await axios.get("/api/hospital", {
                params: {
                    minLng,
                    minLat,
                    maxLng,
                    maxLat
                }
            });

            // 서버 응답: 여전히 EPSG:5174 기준 (p.lng, p.lat) 라고 가정
            const rawHospital = response.data;

            // === 기존 마커들 제거 ===
            clearMarkers();

            // === 5174 → 4326 변환해서 지도에 뿌리기 ===
            const hospital = rawHospital.map(p => {
                const [lng, lat] = proj4("EPSG:5174", "EPSG:4326", [p.lng, p.lat]);
                return { ...p, lng, lat };
            });

            const markers = [];

            hospital.forEach(p => {
                const position = new kakao.maps.LatLng(p.lat, p.lng);
                const marker = new kakao.maps.Marker({ position });

                const content = document.createElement('div');
                content.className = 'overlayBox';
                content.innerHTML = `
                <div class="title"><b>${p.name}</b></div>
                <div class="addr">${p.address}(${p.zip})</div>
                <div class="tel">${p.tel}</div>
                <div class="close"><span class="badge text-bg-danger"><i class="fa-solid fa-xmark"></i></span></div>
            `;

                const overlay = new kakao.maps.CustomOverlay({
                    content: content,
                    position: position,
                    yAnchor: 1.4
                });

                content.querySelector('.close').addEventListener('click', () => {
                    overlay.setMap(null);
                    activeOverlay = null;
                });

                kakao.maps.event.addListener(marker, 'click', () => {
                    closeOverlay();
                    overlay.setMap(map);
                    activeOverlay = overlay;
                });

                markerModels.push({ marker, overlay, data: p });
                markers.push(marker);
            });

            // 클러스터러 사용 시 등록
            if (clusterer) {
                clusterer.addMarkers(markers);
            } else {
                // 클러스터러 안 쓴다면 직접 지도에 올리기
                markers.forEach(m => m.setMap(map));
            }

            // 새 데이터 기준으로 리스트 갱신
            updateVisibleList();
        }

        // ===== 리스트 갱신 =====
        function updateVisibleList() {
            const bounds = map.getBounds();
            const center = map.getCenter();

            // 너무 넓게 축소돼 있으면 안내만
            if (map.getLevel() > 6) {
                listEl.innerHTML = `
                  <li class="border-0 py-3 rounded-3 bg-light text-center">
                    <i class="fa-solid fa-circle-exclamation text-danger me-1"></i>
                    지도를 더 확대하면 병원 목록이 표시됩니다.
                  </li>`;
                return;
            }

            let visible = markerModels.filter(m => bounds.contain(m.marker.getPosition()));

            visible = visible
                .map(m => ({ ...m, dist: distance(center, m.marker.getPosition()) }))
                .sort((a, b) => a.dist - b.dist);

            if (visible.length === 0) {
                listEl.innerHTML = `
                <li class="border-0 py-3 rounded-3 bg-light text-center">
                  <i class="fa-solid fa-circle-exclamation text-danger me-1"></i>현재 화면에 보이는 병원이 없습니다.
                </li>`;
                return;
            }

            const MAX_LIST = 5;
            const sliced = visible.slice(0, MAX_LIST);

            listEl.innerHTML = sliced.map(({ data }, i) => `
              <li data-id="${data.id}">
                <h6 class="mb-1"><i class="fa-solid fa-location-dot text-info me-1"></i>${data.name}</h6>
                <p class="ps-4">${data.address} (${data.zip})</p>
                <p class="ps-4">${data.tel}</p>
              </li>
            `).join('');

            listEl.querySelectorAll('li').forEach(li => {
                li.addEventListener('click', () => {
                    const id = Number(li.dataset.id);
                    const found = markerModels.find(m => m.data.id === id);
                    if (!found) return;
                    map.panTo(found.marker.getPosition());
                    closeOverlay();
                    found.overlay.setMap(map);
                    activeOverlay = found.overlay;
                });
            });
        }

        // ===== 이벤트 연결 =====
        // 처음 로딩할 때 지도 영역 기준으로 병원 불러오기
        loadHospitalsInBounds();

        // 지도 이동/확대 후 idle 될 때마다 새로 서버에서 가져오기 (디바운스 추천)
        let idleTimer = null;
        kakao.maps.event.addListener(map, 'idle', () => {
            if (idleTimer) clearTimeout(idleTimer);
            idleTimer = setTimeout(() => {
                loadHospitalsInBounds();
            }, 300); // 0.3초 정도 디바운스
        });
    });

</script>