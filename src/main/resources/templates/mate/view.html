<!DOCTYPE html>
<html lang="en" layout:decorate="~{include/user}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      xmlns:th="http://www.thymeleaf.org">

<div layout:fragment="content">
    <!-- /* view 화면 html 코드 작성 부분 */ -->
    <div class="page_title mb-4">
        <a class="d-inline-flex align-items-baseline" href="/mate/list">
            <small class="text-danger">산책 게시판 <i class="fa-solid fa-chevron-right fs-xs"></i></small>
        </a>
        <h3 class="memomentKkukkkuk fw-normal mt-2">게시글 보기</h3>
    </div>
    <div class="board_area">
        <div class="card rounded-3">
            <div class="card-body">
                <table class="table table-borderless">
                    <thead>
                    <tr>
                        <td class="tb_title border-bottom pb-3 px-0">
                            <div class="d-flex gap-2 flex-nowrap align-items-end mb-2">
                                <div class="d-flex gap-2 flex-nowrap align-items-center">
                                    <div class="badge badge-gray mb-2">
                                        <span>[[${board.sido}]]</span> / <span>[[${board.sigungu}]]</span>
                                    </div>
                                    <p class="badge badge-info mb-2"
                                       th:if="${board != null and (board.category == '1:1 모집' or board.category == '그룹 모집')}"
                                       th:text="${board.category}">
                                    </p>
                                    <!--                      <p class="badge badge-success">[[${board.category}]]</p>        -->
                                </div>
                                <!-- 로그인 사용자 == 글작성자 같을 경우만 노출 -->
                                <div class="d-flex gap-1 flex-nowrap ms-auto">
                                    <a class="btn btn-danger" th:href="@{/mate/remove(bno=${board.bno})}">삭제</a>
                                    <a class="btn btn-gray" th:href="@{/mate/modify(bno=${board.bno}, mode=2)}">수정</a>
                                    <!--                         추가 할 것-->
                                </div>
                                <!-- // 로그인 사용자 == 글작성자 같을 경우만 노출 끝 -->
                            </div>
                            <h4 class="py-2">[[${board.title}]]</h4>
                            <div class="d-flex gap-2 flex-nowrap text-secondary">
                                <p>[[${board.nickname}]]</p>
                                <p>[[${#temporals.format(board.regDate, 'yyyy-MM-dd HH:mm:ss')}]]</p>

                                <p class="ms-auto mb-0 d-flex align-items-center">
                                    <i class="fa-regular fa-eye me-1"></i>
                                    <span th:text="${board.readCount}">0</span>

                                    <i class="like-btn"
                                       th:attr="data-bno=${board.bno}"
                                       th:class="${board.likecount >= 1}
                                         ? 'fa-solid fa-heart ms-3 me-1 text-danger'
                                         : 'fa-regular fa-heart ms-3 me-1 text-danger'"></i>

                                    <span class="like-count"
                                          th:attr="data-bno=${board.bno}"
                                          th:text="${board.likecount}">0</span>
                                    <i class="fa-regular fa-comment-dots ms-3 me-1"></i>
                                    <span class="reply-count" th:text="${board.replyCount} ?: 0">0</span>
                                </p>
                            </div>

                        </td>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- 첨부파일이 있으면 노출 -->
                    <tr th:if="${board.mateFileDTOs != null && board.mateFileDTOs.size > 0}">
                        <td class="px-0 py-3">
                            <ul>
                                <li class="mb-2" th:each="file:${board.mateFileDTOs}">
                                    <div class="img_wrap">
                                        <img th:src="|/uploads/mate/${file.uuid}_${file.filename}|">
                                    </div>
                                </li>
                            </ul>
                        </td>
                    </tr>
                    <!-- 첨부파일이 있으면 노출 끝 -->
                    <tr>
                        <td class="px-0 py-3">
                            <div class="tb_content">[[${board.content}]]</div>
                        </td>
                    </tr>
                    <tr>
                        <td class="px-0 pt-3">
                            <!-- 좋아요 버튼 -->
                            <div class="d-flex justify-content-center align-items-center mb-2">
                                    <button type="button" class="btn btn-outline-danger" id="likeBtn">좋아요!</button>
                            </div>
                            <!-- 신청마감일 표시 블록 -->
                            <div class="mt-1" th:if="${board.dueDate != null}">
                                신청마감일 :
                                <span th:text="${board.dueDisplay}"
                                      th:classappend="${board.expired} ? ' text-secondary' : ' text-danger'">
                                </span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="px-0 pt-3">
                            <p>
                                <i class="fa-regular fa-comment-dots me-1"></i>
                                댓글 <b class="text-danger">[[${board.replyCount}]]</b>
                            </p>
                            <div class="reply_list_area">
                                <ul class="replyList"></ul>
                                <ul class="replyPaging pagination pagination-sm mt-3"></ul>
                            </div>
                            <div>
                                <ul class="pagination replyPaging"></ul>
                            </div>
                            <div class="replyModal">
                                <div class="reply_write_area pt-3">
                                    <div class="mb-2">
                                        <textarea class="replyText form-control" name="replyText"
                                                  placeholder="댓글 내용을 입력해주세요(최대 1000자)"></textarea>
                                    </div>
                                        <div class="d-flex">
                                            <button class="btnReplyRegister ms-auto btn btn-main" type="button">댓글 쓰기</button>
                                        </div>
                                </div>
                            </div>

                            <!-- 댓글 수정 -->
                            <div class="modal modifyModal" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-body">
                                            <div class="input-group mb-3">
                                                <input class="form-control modifyText" type="text">
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button class="btn btn-dark modifyCloseBtn" type="button">닫기</button>
                                            <button class="btn btn-primary modifyBtn2" type="button">수정</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- /* //view 화면 html 코드 작성 끝 */ -->
</div>



<script layout:fragment="pagescript" th:inline="javascript">

    const bno = [[${board.bno}]];
    const replyList = document.querySelector(".replyList");
    const replyPaging = document.querySelector(".replyPaging")
    const boardUsername = [[${board.username}]];
    //지금 로그인 중인 회원
    const loginUser = [[${#authentication.principal.username}]];
    const loginRole = [[${#authentication.principal.authorities[0].authority}]]


    let page = 1;
    let size = 10;

        /* ============================
           1. 댓글 리스트 렌더링
        ============================ */
    function printList(dtoList) {
        let str = '';
        if (dtoList && dtoList.length > 0) {
            for (let dto of dtoList) {
                str += `
        <li class="reply_list border-bottom" data-rno="${dto.rno}">
          <div class="d-flex justify-content-start align-items-start gap-2 py-2">
            <div class="flex-grow-1">
      `;
                if (dto.deleted) {
                    str += `<div class="replyContent text-secondary">삭제된 댓글입니다.</div>`;
                } else if (dto.secret && !(dto.username === loginUser || boardUsername === loginUser)) {
                    str += `<div class="replyContent text-muted">비밀 댓글입니다.</div>`;
                } else {
                    str += `<b>${dto.nickname}</b><div class="replyContent">${dto.content}</div>`;
                }
                str += `
            </div>
            <div class="flex-shrink-1">
              ${dto.deleted ? '' : `
              <div class="btn-group">
                <button type="button" class="btn btn-xs rounded-2 btn-outline-gray" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fa-solid fa-ellipsis"></i>
                </button>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item modifyBtn" href="#">수정</a></li>
                  <li><a class="dropdown-item deleteBtn" href="#">삭제</a></li>
<!--                  <li><a class="btnReReplyWriteView dropdown-item" href="#">대댓글 달기</a></li>-->
                </ul>
              </div>`}
            </div>
          </div>
        </li>`;
            }
        }
        replyList.innerHTML = str;
    }

    /* ============================
       2. 페이지네이션 렌더링
    ============================ */
    function printPages(data) {
        const replyPaging = document.querySelector(".replyPaging");
        if (!data.dtoList || data.dtoList.length === 0) {
            replyPaging.innerHTML = '';
            return;
        }
        let pageStr = '';
        if (data.prev) {
            pageStr += `<li class="page-item"><a class="page-link" data-page="${data.start - 1}"><i class="fa-solid fa-chevron-left"></i></a></li>`;
        }
        for (let i = data.start; i <= data.end; i++) {
            pageStr += `<li class="page-item ${Number(i) === Number(data.page) ? "active" : ""}"><a class="page-link" data-page="${i}">${i}</a></li>`;
        }
        if (data.next) {
            pageStr += `<li class="page-item"><a class="page-link" data-page="${data.end + 1}"><i class="fa-solid fa-chevron-right"></i></a></li>`;
        }
        replyPaging.innerHTML = pageStr;
    }

    /* ============================
       3. 댓글 불러오기 + 카운트 갱신
    ============================ */
    async function printReplies(bno, page, size, goLast) {
        const response = await axios.get(`/matereplies/list/${bno}`, { params: { page, size } });
        const data = response.data;

        if (goLast) {
            const total = data.total;
            const lastPage = Math.ceil(total / size);
            return printReplies(bno, lastPage, size, false);
        }

        printList(data.dtoList);
        printPages(data);

        if (typeof data.total === 'number') {
            document.querySelector('.reply-count')?.replaceChildren(document.createTextNode(data.total));
        }
    }
    printReplies(bno, page, size, false);


    /* ============================
       4. 댓글 등록/수정/삭제
    ============================ */
    const registerBtn = document.querySelector(".btnReplyRegister");
    const replyText = document.querySelector(".replyText");
    const modifyModal = new bootstrap.Modal(document.querySelector(".modifyModal"));
    const modifyText = document.querySelector(".modifyText");
    const modifyCloseBtn = document.querySelector(".modifyCloseBtn");


    // 댓글 등록
    registerBtn.addEventListener("click", async () => {
        const replyObj = {
            bno,
            content: replyText.value,
            secret: 0, // 항상 공개 댓글
            deleted: false
        };
        try {
            await axios.post(`/matereplies/`, replyObj);
            replyText.value = '';
            printReplies(bno, 1, 10, false);
        } catch (err) {
            alert("댓글 입력 오류");
            console.error(err);
        }
    });

    // 댓글 수정/삭제/대댓글 토글
    $(document).on('click', '.reply_list a', async function (e) {
        e.preventDefault();
        const $target = $(this);
        const $li = $target.closest("li.reply_list");
        const rno = $li.data('rno');

        if ($target.hasClass('modifyBtn')) {
            const res = await axios.get(`/matereplies/${rno}`);
            modifyText.value = res.data.content;
            modifyModal.show();

            document.querySelector(".modifyBtn2").onclick = async function () {
                await axios.put(`/matereplies/${rno}`, { rno, content: modifyText.value });
                modifyModal.hide();
                printReplies(bno, page, size, false);
            };
            modifyCloseBtn.onclick = () => modifyModal.hide();
        }

        if ($target.hasClass('deleteBtn')) {
            await axios.post(`/matereplies/delete/${rno}`);
            printReplies(bno, page, size, false);
        }
    });

    /* ============================
       5. 대댓글 토글 + 등록
    ============================ */
    function reReplyStr() {
        return `
    <div class="reReplyWriteArea mt-2">
      <div class="d-flex justify-content-start align-items-start gap-2 py-2">
        <div class="flex-grow-1">
          <div class="mb-2">
            <textarea class="form-control reReplyText" placeholder="대댓글 내용을 입력해주세요(최대 1000자)"></textarea>
          </div>
          <div class="d-flex">
            <label class="form-check-label me-2">비밀대댓글</label>
            <input class="form-check-input reSecretCheck" type="checkbox">
            <button class="btnReReplyRegister ms-auto btn btn-main">대댓글 쓰기</button>
          </div>
        </div>
        <div class="flex-shrink-1">
          <button class="btnReReplyWriteClose btn btn-xs btn-outline-danger">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
      </div>
    </div>`;
    }

    $(document).on('click', '.btnReReplyWriteView', function (e) {
        e.preventDefault();
        const $li = $(this).closest('li.reply_list');
        const $exist = $li.find('.reReplyWriteArea');
        if ($exist.length) { $exist.remove(); return; }
        $li.append(reReplyStr());
    });

    $(document).on('click', '.btnReReplyWriteClose', function () {
        $(this).closest('.reReplyWriteArea').remove();
    });

    $(document).on('click', '.btnReReplyRegister', async function () {
        const $area = $(this).closest('.reReplyWriteArea');
        const $li   = $(this).closest('li.reply_list');
        const parentRno = $li.data('rno');
        const content   = $area.find('.reReplyText').val().trim();
        const secret    = $area.find('.reSecretCheck').is(':checked') ? 1 : 0;

        if (!content) { alert('내용을 입력해주세요'); return; }

        try {
            await axios.post('/matereplies/', { bno, content, secret, parentRno });
            $area.remove();
            printReplies(bno, page, size, false);
        } catch (err) {
            console.error(err);
            alert('대댓글 등록 실패');
        }
    });

    /* ============================
       6. 페이지네이션 클릭
    ============================ */
    $(document).on('click', '.replyPaging .page-link', function (e) {
        e.preventDefault();
        const pageNum = Number($(this).data('page'));
        page = pageNum;
        printReplies(bno, page, size, false);
    });


    /* ============================
       7. 좋아요 (공통함수 + 버튼)
    ============================ */
    function sendLike(bno, $icon, $count) {
        let current = parseInt($count.text() || '0', 10);
        $count.text(current + 1);
        if ($icon && $icon.length) $icon.removeClass('fa-regular').addClass('fa-solid');

        const token  = $('meta[name="_csrf"]').attr('content');
        const header = $('meta[name="_csrf_header"]').attr('content');

        $.ajax({
            url: '/mate/like',
            type: 'POST',
            contentType: 'application/json',
            dataType: 'json',
            cache: false,
            data: JSON.stringify({ bno }),
            beforeSend: function (xhr) {
                if (token && header) xhr.setRequestHeader(header, token);
            },
            success: function (res) {
                if (res && typeof res.likecount === 'number') {
                    $count.text(res.likecount);
                    if (res.likecount > 0) {
                        $icon.removeClass('fa-regular').addClass('fa-solid');
                    } else {
                        $icon.removeClass('fa-solid').addClass('fa-regular');
                    }
                }
            },
            error: function (xhr) {
                $count.text(current);
                if ($icon && $icon.length && current === 0) {
                    $icon.removeClass('fa-solid').addClass('fa-regular');
                }
                alert('좋아요 처리 실패 ㅠㅠ\nstatus: ' + xhr.status);
            }
        });
    }

    $(document).on('click', '.like-btn', function () {
        const $icon  = $(this);
        const bno    = $icon.data('bno');
        const $row   = $icon.closest('p');
        const $count = $row.find('.like-count[data-bno="' + bno + '"]');
        sendLike(bno, $icon, $count);
    });

    $(document).on('click', '#likeBtn', function () {
        const $count = $('.like-count[data-bno="' + bno + '"]');
        const $icon  = $('.like-btn[data-bno="' + bno + '"]');
        sendLike(bno, $icon, $count);
    });
</script>

