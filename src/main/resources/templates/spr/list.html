<!DOCTYPE html>
<html lang="en" layout:decorate="~{include/user}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      xmlns:th="http://www.thymeleaf.org">

<div layout:fragment="content">
  <!-- /* view 화면 html 코드 작성 부분 */ -->
  <div class="page_title mb-4 mb-md-5">
    <h3 class="memomentKkukkkuk fw-normal mb-2">사고팔개</h3>
    <small class="text-secondary">나눔&middot;공구&middot;신고 게시판이에요. 카테고리랑 상관없는 게시글은 삭제될 수 있어요.</small>
  </div>
  <div class="board_area">
    <div class="row g-4">
      <!-- ===================== 필터 영역 ===================== -->
      <div class="col-12 col-sm-10 col-md-8 col-lg-6 mx-auto">
        <section class="search_area">
          <form action="/spr/list" id="filterForm" method="get">
            <div class="d-flex justify-content-start align-items-baseline flex-nowrap gap-2 mb-2">
              <!--  카테고리 선택 -->
              <select class="form-select form-select-sm w-100 flex-grow-1" name="category" onchange="this.form.submit()">
                <option th:selected="${category == null or category == ''}" value="">나눔/공구/신고</option>
                <option th:selected="${category == '나눔'}" value="나눔">나눔</option>
                <option th:selected="${category == '공구'}" value="공구">공구</option>
                <option th:selected="${category == '신고'}" value="신고">신고</option>
              </select>
              <!--  진행중만 보기 (전체/나눔/공구일 때 표시) -->
              <div class="form-check mb-0 flex-shrink-1" th:if="${category == null or category == '' or category == '나눔' or category == '공구'}">
                <input id="completeInput" name="complete" th:value="${complete}" type="hidden">
                <input class="form-check-input" id="completeCheckbox" th:checked="${complete}" type="checkbox">
                <label class="form-check-label text-nowrap" for="completeCheckbox">나눔/공구 완료 제외</label>
              </div>
            </div>
          </form>
          <!-- ===================== 검색 영역 ===================== -->
          <form action="/spr/list" id="searchForm">
            <input name="category" th:value="${category}" type="hidden">
            <input name="sort" th:value="${sort}" type="hidden">
            <input name="complete" th:value="${complete}" type="hidden">
            <div class="d-flex gap-2">
              <select class="form-select form-select-sm w-auto flex-shrink-1" name="type">
                <option value="">검색어</option>
                <option th:selected="${pageRequestDTO.type=='tc'}" value="tc">제목+내용</option>
                <option th:selected="${pageRequestDTO.type=='t'}" value="t">제목</option>
                <option th:selected="${pageRequestDTO.type=='c'}" value="c">내용</option>
                <option th:selected="${pageRequestDTO.type=='w'}" value="w">작성자</option>
              </select>
              <input class="form-control form-control-sm" name="keyword" placeholder="검색어를 입력하세요"
                     th:value="${pageRequestDTO.keyword}" type="text">
              <button class="btn btn-sm btn-secondary text-nowrap" type="submit">
                <i class="fa-solid fa-magnifying-glass me-1"></i>검색
              </button>
              <a th:href="@{/spr/list}" class="btn btn-sm btn-gray text-nowrap">초기화</a>
            </div>
          </form>
        </section>
      </div>

      <!-- ===================== 정렬 버튼 영역 ===================== -->
      <div class="col-12">
        <div class="d-flex align-items-end mb-2">
          <div class="btn-group" role="group">
            <a class="btn btn-sm"
               th:classappend="${sort=='recent'} ? 'btn-secondary' : 'btn-outline-secondary'"
               th:href="@{/spr/list(category=${category}, type=${pageRequestDTO.type}, keyword=${pageRequestDTO.keyword}, complete=${complete}, sort='recent')}">
              최신순
            </a>
            <a class="btn btn-sm"
               th:classappend="${sort=='read'} ? 'btn-secondary' : 'btn-outline-secondary'"
               th:href="@{/spr/list(category=${category}, type=${pageRequestDTO.type}, keyword=${pageRequestDTO.keyword}, complete=${complete}, sort='read')}">
              조회수순
            </a>
            <a class="btn btn-sm"
               th:classappend="${sort=='recommend'} ? 'btn-secondary' : 'btn-outline-secondary'"
               th:href="@{/spr/list(category=${category}, type=${pageRequestDTO.type}, keyword=${pageRequestDTO.keyword}, complete=${complete}, sort='recommend')}">
              추천순
            </a>
          </div>
          <div class="ms-auto" sec:authorize="isAuthenticated()">
            <a class="btn btn-main px-4" href="/spr/register"><i class="fa-solid fa-pencil"></i> 글쓰기</a>
          </div>
        </div>

        <table class="table border-top align-middle">
          <colgroup>
            <col style="width:40px;">
            <col style="width:calc(100% - 40px);">
          </colgroup>
          <thead>
          <tr>
            <td>no.</td>
            <td>내용</td>
          </tr>
          </thead>
          <tbody>
          <tr th:each="board:${responseDTO.dtoList}">
            <td>[[${board.bno}]]</td>
            <td>
              <div class="py-2">
                <div class="d-flex gap-2 flex-nowrap mb-2">
                  <p th:if="${board.category == '신고'}" class="badge text-bg-danger">&#x1F6AB; [[${board.category}]]</p>
                  <p th:if="${board.category == '공구'}" class="badge badge-warning">&#x1F6D2; [[${board.category}]]</p>
                  <p th:if="${board.category == '나눔'}" class="badge badge-warning">&#x1F381; [[${board.category}]]</p>
                  <!-- 나눔 / 공구 카테고리일 때 진행중 / 완료 표시 뱃지 -->
                  <p class="badge badge-info" th:if="${board.category == '나눔' || board.category == '공구'} and ${board.complete == false}">
                    [[${board.category}]]중
                  </p>
                  <p class="badge badge-success" th:if="${board.category == '나눔' || board.category == '공구'} and ${board.complete == true}">
                    [[${board.category}]]완료
                  </p>
                  <p class="text-nowrap badge badge-danger" th:if="${board.category == '공구'} and ${board.complete == false}">[[${board.dueDate}]]까지</p>
                </div>
                <div class="d-flex gap-2 flex-nowrap mb-2" th:if="${board.category == '나눔'}">
                  <!-- 나눔 카테고리일 때 시도 시군구 표시 뱃지 -->
                  <p class="badge badge-gray">[[${board.sido}]] / [[${board.sigungu}]]</p>
                </div>
                <a th:href="@{/spr/view(bno=${board.bno}, mode=1)}" class="d-block mb-1">
                  <h5 class="text-overflew-line-1">[[${board.title}]]</h5>
                </a>
                <div class="d-flex gap-2 flex-nowrap text-secondary">
                  <p>[[${board.author}]]</p>
                  <p>[[${#temporals.format(board.regDate, 'yyyy-MM-dd')}]]</p>
                  <p class="ms-auto"><i class="fa-regular fa-eye me-1"></i>[[${board.readcount}]]</p>
                  <p th:if="${board.recommend >= 1}"><i class="fa-solid fa-heart me-1 text-danger"></i>[[${board.recommend}]]
                  </p>
                  <p th:if="${board.recommend == 0}"><i class="fa-regular fa-heart me-1 text-danger"></i>[[${board.recommend}]]
                  </p>
                  <p><i class="fa-regular fa-comment-dots me-1"></i>[[${board.replyCount}]]</p>
                </div>
              </div>
            </td>
          </tr>
          <tr th:if="${responseDTO.page == responseDTO.last}">
            <td colspan="2">
              <p class="py-3 text-center">게시글이 없어요</p>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
      <div class="col-12 col-sm-10 col-md-8 col-lg-6 mx-auto">
        <section class="paging_area">
          <nav aria-label="Page navigation">
            <ul class="pagination pagination-sm justify-content-center mb-0">
              <li class="page-item">
                <a class="page-link" th:data-num="${responseDTO.start}"><i class="fa-solid fa-angles-left"></i></a>
              </li>
              <li class="page-item" th:if="${responseDTO.prev}">
                <a class="page-link" th:data-num="${responseDTO.start -1}"><i class="fa-solid fa-chevron-left"></i></a>
              </li>
              <th:block th:each="i:${#numbers.sequence(responseDTO.start, responseDTO.end)}">
                <li th:class="${responseDTO.page==i}?'page-item active':'page-item'">
                  <a class="page-link" th:data-num="${i}">[[${i}]]</a>
                </li>
              </th:block>
              <li class="page-item" th:if="${responseDTO.next}">
                <a class="page-link" th:data-num="${responseDTO.end +1}"><i class="fa-solid fa-chevron-right"></i></a>
              </li>
              <li class="page-item">
                <a class="page-link" th:data-num="${responseDTO.end}"><i class="fa-solid fa-angles-right"></i></a>
              </li>
            </ul>
          </nav>
        </section>
      </div>
    </div>
  </div>
  <!-- /* //view 화면 html 코드 작성 끝 */ -->
</div>

<script layout:fragment="pagescript" th:inline="javascript">

    document.addEventListener("DOMContentLoaded", () => {
        const checkbox = document.getElementById('completeCheckbox')
        const hiddenInput = document.getElementById('completeInput')
        const form = document.getElementById('filterForm')

        if (checkbox) {
            checkbox.addEventListener('change', () => {
                if (checkbox.checked) {
                    hiddenInput.value = 'true';
                } else {
                    hiddenInput.remove();
                }
                form.submit()
            })
        }
    })

    // 페이지에 필요한 스크립트 작성 부분
    document.querySelector(".pagination").addEventListener("click", function (e) {
        e.preventDefault()
        e.stopPropagation()

        const target = e.target.closest('a')
        if (!target) {
            return
        }
        const num = target.getAttribute("data-num")
        const formOjb = document.querySelector("#searchForm")
        formOjb.innerHTML += `<input type='hidden' name='page' value='${num}'>`
        formOjb.submit()
    })

    // 페이지에 필요한 스크립트 작성 끝
</script>